# C:\Tools\atomic-mesh\control_panel.ps1
# ATOMIC MESH COMMANDER v7.5 - Slash-Command Edition + Multi-Project
# FEATURES: Discord-style /commands, natural language chat, multi-project grid

param(
    [string]$ProjectName = "Standalone",
    [string]$ProjectPath = "",
    [string]$DbPath = "mesh.db"
)

# Set working directory and database
if ($ProjectPath -and (Test-Path $ProjectPath)) {
    Set-Location $ProjectPath
}
$CurrentDir = (Get-Location).Path
$DB_FILE = Join-Path $CurrentDir $DbPath
$LogDir = "$CurrentDir\logs"
$DocsDir = "$CurrentDir\docs"
$MilestoneFile = "$CurrentDir\.milestone_date"
$SpecFile = "$DocsDir\ACTIVE_SPEC.md"
$RepoRoot = if ($PSScriptRoot) { Resolve-Path "$PSScriptRoot\.." } else { $CurrentDir }

# Set environment for Python
$env:ATOMIC_MESH_DB = $DB_FILE

# Update window title
$host.UI.RawUI.WindowTitle = "Atomic Mesh :: $ProjectName"

# Ensure directories exist
if (!(Test-Path $LogDir)) { New-Item -ItemType Directory -Path $LogDir | Out-Null }
if (!(Test-Path $DocsDir)) { New-Item -ItemType Directory -Path $DocsDir | Out-Null }

# Layout constants
$TotalWidth = 77

# ============================================================================
# COMMAND REGISTRY - All slash commands defined here
# ============================================================================

$Global:Commands = [ordered]@{
    # EXECUTION
    "go"             = @{ Desc = "execute the next pending task"; Alias = @("continue", "c", "run") }
    
    # TASK MANAGEMENT
    "add"            = @{ Desc = "add task: /add backend|frontend <description>"; HasArgs = $true }
    "skip"           = @{ Desc = "skip a task: /skip <task_id>"; HasArgs = $true }
    "reset"          = @{ Desc = "reset failed task: /reset <task_id>"; HasArgs = $true }
    "drop"           = @{ Desc = "delete a task: /drop <task_id>"; HasArgs = $true }
    "nuke"           = @{ Desc = "clear all pending (requires --confirm)"; HasArgs = $true }
    
    # AGENTS
    "audit"          = @{ Desc = "open auditor status and log" }
    "lib"            = @{ Desc = "librarian: /lib scan|status|approve|execute"; HasArgs = $true }
    "ingest"         = @{ Desc = "v9.1: compile raw PRDs from inbox to specs" }
    
    # v9.6 RIGOR (Status Only)
    "rigor"          = @{ Desc = "v9.6: show Phase x Risk matrix (auto-derived)" }
    
    # v9.7 CORE LOCK
    "unlock"         = @{ Desc = "v9.7: unlock core paths: /unlock [core|session]"; HasArgs = $true }
    "lock"           = @{ Desc = "v9.7: lock core paths immediately" }
    
    # v9.8 CLARIFICATION
    "questions"      = @{ Desc = "v9.8: view open clarification questions" }
    "answer"         = @{ Desc = "v9.8: answer a question: /answer Q1 'your answer'"; HasArgs = $true }
    
    # v9.9 REVIEWER
    "review"         = @{ Desc = "v9.9: view review status: /review [task_id]"; HasArgs = $true }
    "rules"          = @{ Desc = "v9.9: view domain rules (the law)" }
    
    # STREAMS
    "stream"         = @{ Desc = "view worker output: /stream backend|frontend"; HasArgs = $true }
    
    # MULTI-PROJECT
    "multi"          = @{ Desc = "launch multi-project grid: /multi 1 2 3"; HasArgs = $true }
    "projects"       = @{ Desc = "list available projects" }
    
    # LIBRARY (v7.6)
    "init"           = @{ Desc = "start a new project (bootstrap + /work)" }
    "profile"        = @{ Desc = "show/set project profile: /profile [name]"; HasArgs = $true }
    "standard"       = @{ Desc = "view a standard: /standard security|architecture"; HasArgs = $true }
    "standards"      = @{ Desc = "list all standards for current profile" }
    
    # v8.0 PRE-FLIGHT
    "ship"           = @{ Desc = "commit and push to GitHub (trusts local QA)"; HasArgs = $true }
    "preflight"      = @{ Desc = "run local pre-flight tests" }
    
    # CONTEXT
    "decide"         = @{ Desc = "answer decision: /decide <id> <answer>"; HasArgs = $true }
    "note"           = @{ Desc = "add a note: /note <text>"; HasArgs = $true }
    "blocker"        = @{ Desc = "report blocker: /blocker <text>"; HasArgs = $true }
    
    # CONFIGURATION
    "mode"           = @{ Desc = "show/toggle mode: /mode [vibe|converge|ship]"; HasArgs = $true }
    "milestone"      = @{ Desc = "set milestone: /milestone YYYY-MM-DD"; HasArgs = $true }
    
    # SESSION
    "status"         = @{ Desc = "show system status dashboard" }
    "plan"           = @{ Desc = "show project roadmap" }
    "tasks"          = @{ Desc = "list all tasks" }
    "help"           = @{ Desc = "show Golden Path (/help --all for full registry)"; Alias = @("?") }
    "commands"       = @{ Desc = "[LEGACY] use /help instead" }
    "refresh"        = @{ Desc = "refresh the display" }
    "clear"          = @{ Desc = "clear the console screen" }
    "quit"           = @{ Desc = "exit Atomic Mesh"; Alias = @("q", "exit") }
    
    # v8.2 DIAGNOSTICS
    "doctor"         = @{ Desc = "run system health check (Gap #3)" }

    # v8.4.1 SPEC ANALYSIS
    "refine"         = @{ Desc = "analyze ACTIVE_SPEC.md for ambiguities" }

    # v13.1 VIEW COMMANDS
    "dash"           = @{ Desc = "v13.1: force full dashboard view" }
    "compact"        = @{ Desc = "v13.1: force compact view" }

    # v13.2 OPS COMMANDS (Golden Path)
    "ops"            = @{ Desc = "v13.2: Health + Drift + Backups overview" }
    "health"         = @{ Desc = "v13.2: system health check" }
    "drift"          = @{ Desc = "v13.2: staleness and queue drift check" }
    "work"           = @{ Desc = "v13.2: knowledge acquisition: /work <PREFIX>"; HasArgs = $true }

    # SANDBOX UX: Router Debug
    "router-debug"   = @{ Desc = "toggle router debug overlay" }

    # TDD
    "scaffold-tests" = @{ Desc = "v13.2 autogenerate pytest scaffold: /scaffold-tests <task_id>"; HasArgs = $true }
}


# ============================================================================
# DATABASE HELPER
# ============================================================================

function Invoke-Query {
    param([string]$Query, [switch]$Silent)
    
    # Basic SQL injection protection
    $dangerousPatterns = @("DROP TABLE", "DELETE FROM tasks", "--", ";--")
    foreach ($pattern in $dangerousPatterns) {
        if ($Query -match [regex]::Escape($pattern)) {
            if (-not $Silent) { Write-Host "  üî¥ Query rejected" -ForegroundColor Red }
            return @()
        }
    }
    
    $script = @"
import sqlite3, json
try:
    conn = sqlite3.connect('$DB_FILE')
    conn.row_factory = sqlite3.Row
    rows = conn.execute('''$Query''').fetchall()
    print(json.dumps([dict(r) for r in rows]))
    conn.close()
except: print('[]')
"@
    try {
        $result = $script | python 2>$null
        if ($result) { return $result | ConvertFrom-Json }
    }
    catch {}
    return @()
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

function Get-ProjectMode {
    if (Test-Path $MilestoneFile) {
        try {
            $milestone = Get-Content $MilestoneFile -Raw
            $daysLeft = ((Get-Date $milestone) - (Get-Date)).Days
            if ($daysLeft -le 2) { return @{ Mode = "SHIP"; Days = $daysLeft; Color = "Red"; Icon = "üî¥" } }
            elseif ($daysLeft -le 7) { return @{ Mode = "CONVERGE"; Days = $daysLeft; Color = "Yellow"; Icon = "üü°" } }
            else { return @{ Mode = "VIBE"; Days = $daysLeft; Color = "Green"; Icon = "üü¢" } }
        }
        catch {}
    }
    return @{ Mode = "VIBE"; Days = $null; Color = "Green"; Icon = "üü¢" }
}

function Get-TaskStats {
    $stats = Invoke-Query "SELECT status, COUNT(*) as c FROM tasks GROUP BY status" -Silent
    $result = @{ pending = 0; in_progress = 0; completed = 0; failed = 0 }
    foreach ($s in $stats) {
        if ($s.status) { $result[$s.status] = $s.c }
    }
    return $result
}

# ============================================================================
# COMMAND CATALOG (v13.3) - Beginner-first, progressive disclosure
# ============================================================================

function Get-CommandCatalog {
    param([bool]$ShowAll = $false)

    # Tier 1: Golden Path - Beginner-safe essentials (max 9)
    $goldenPath = @("help", "init", "ops", "plan", "run", "status", "ship", "snapshots", "restore")

    # Tier 2: Advanced/Maintenance (shown with --all)
    $advanced = @("work", "approve", "approve_source", "snapshot", "restore_confirm", "review", "rules", "questions", "answer", "unlock", "lock", "mode", "milestone", "preflight", "doctor", "refine", "stream", "decide", "note", "blocker", "profile", "standard", "standards", "multi", "projects", "patterns", "incident", "mine")

    # Tier 3: Deprecated/Legacy (shown with --all, marked deprecated)
    $deprecated = @("go", "add", "skip", "drop", "reset", "nuke", "audit", "lib", "ingest", "rigor", "commands")

    # Session commands (shown with --all)
    $session = @("quit", "clear", "refresh", "tasks", "dash", "compact")

    $result = @{
        GoldenPath = @()
        Advanced   = @()
        Deprecated = @()
        Session    = @()
    }

    foreach ($cmd in $goldenPath) {
        if ($Global:Commands.Contains($cmd)) {
            $result.GoldenPath += [PSCustomObject]@{ Name = $cmd; Desc = $Global:Commands[$cmd].Desc; Tier = "golden" }
        }
    }

    if ($ShowAll) {
        foreach ($cmd in $advanced) {
            if ($Global:Commands.Contains($cmd)) {
                $result.Advanced += [PSCustomObject]@{ Name = $cmd; Desc = $Global:Commands[$cmd].Desc; Tier = "advanced" }
            }
        }
        foreach ($cmd in $deprecated) {
            if ($Global:Commands.Contains($cmd)) {
                $result.Deprecated += [PSCustomObject]@{ Name = $cmd; Desc = "[DEPRECATED] $($Global:Commands[$cmd].Desc)"; Tier = "deprecated" }
            }
        }
        foreach ($cmd in $session) {
            if ($Global:Commands.Contains($cmd)) {
                $result.Session += [PSCustomObject]@{ Name = $cmd; Desc = $Global:Commands[$cmd].Desc; Tier = "session" }
            }
        }
    }

    return $result
}

# Returns flat list of commands for inline picker (Golden Path + optional filter match)
function Get-PickerCommands {
    param([string]$Filter = "")

    # SANDBOX UX: Priority commands (always shown first)
    $priorityOrder = @("help", "init", "ops", "plan", "run", "ship")

    if ($Filter -eq "") {
        $result = @()
        foreach ($cmdName in $priorityOrder) {
            if ($Global:Commands.Contains($cmdName)) {
                $result += [PSCustomObject]@{Name = $cmdName; Desc = $Global:Commands[$cmdName].Desc; Tier = "priority" }
            }
        }
        $catalog = Get-CommandCatalog -ShowAll $false
        foreach ($cmd in ($catalog.GoldenPath | Sort-Object -Property Name)) {
            if ($cmd.Name -notin $priorityOrder) {
                $result += $cmd
            }
        }
        return $result
    }
    else {
        $priorityMatches = @()
        $otherMatches = @()
        foreach ($k in $Global:Commands.Keys) {
            if ($k -like "$Filter*") {
                $cmdObj = [PSCustomObject]@{Name = $k; Desc = $Global:Commands[$k].Desc; Tier = "all" }
                if ($k -in $priorityOrder) {
                    $priorityMatches += $cmdObj
                }
                else {
                    $otherMatches += $cmdObj
                }
            }
        }
        $sortedOthers = $otherMatches | Sort-Object -Property Name
        $sortedPriority = @()
        foreach ($cmd in $priorityOrder) {
            $match = $priorityMatches | Where-Object { $_.Name -eq $cmd }
            if ($match) { $sortedPriority += $match }
        }
        return $sortedPriority + $sortedOthers
    }
}

function Show-Header {
    $proj = Get-ProjectMode
    $stats = Get-TaskStats
    
    # Get console width - use full width
    $width = $Host.UI.RawUI.WindowSize.Width - 1
    $line = "-" * ($width - 2)
    
    # Build title line: Project Name (left) ... Path (right)
    $path = $CurrentDir
    $maxPathLen = $width - $ProjectName.Length - 15
    if ($path.Length -gt $maxPathLen -and $maxPathLen -gt 10) {
        $path = "..." + $path.Substring($path.Length - ($maxPathLen - 3))
    }
    
    # Calculate padding
    $padLen = $width - 6 - $ProjectName.Length - $path.Length
    if ($padLen -lt 1) { $padLen = 1 }
    $padding = " " * $padLen
    
    Write-Host ""
    Write-Host "+$line+" -ForegroundColor Cyan
    
    # Line 1: Project Name (left) ... Path (right)
    Write-Host "| " -NoNewline -ForegroundColor Cyan
    Write-Host "[>] $ProjectName" -NoNewline -ForegroundColor Yellow
    Write-Host "$padding$path " -NoNewline -ForegroundColor DarkGray
    Write-Host "|" -ForegroundColor Cyan
    
    # Line 2: Mode, Stats, Health, and CLI Mode (v13.2: modal mode)
    $modeStr = "$($proj.Icon) $($proj.Mode)"
    if ($null -ne $proj.Days) { $modeStr += " ($($proj.Days)d)" }
    $statsStr = "$($stats.pending) pending | $($stats.in_progress) active | $($stats.completed) done"
    $healthIcon = switch ($Global:HealthStatus) { "OK" { "üü¢" } "WARN" { "üü°" } "FAIL" { "üî¥" } default { "‚ö™" } }
    $statusLine = "  $modeStr | $statsStr | $healthIcon"
    $statusPad = $width - 3 - $statusLine.Length
    if ($statusPad -lt 0) { $statusPad = 0 }

    Write-Host "|$statusLine" -NoNewline -ForegroundColor White
    Write-Host (" " * $statusPad) -NoNewline
    Write-Host "|" -ForegroundColor Cyan
    
    Write-Host "+$line+" -ForegroundColor Cyan
}

# v13.1: Minimal health check (wraps existing sentinels)
function Get-SystemHealthStatus {
    try {
        $health = python -c "from mesh_server import get_health_report; print(get_health_report())" 2>&1
        if ($health -match "FAIL") { return "FAIL" }
        if ($health -match "WARN") { return "WARN" }
        return "OK"
    }
    catch { return "OK" }
}

# ============================================================================
# COMMAND SUGGESTION SYSTEM (Codex-style)
# ============================================================================

# Global state for command selection
$Global:SelectedIndex = 0
$Global:VisibleCommands = @()
$Global:MaxVisible = 8  # Show max 8 commands at once
$Global:ScrollOffset = 0

# v13.1: View mode state (minimal)
$Global:ViewOverride = $null  # null=auto, "dash", "compact"
$Global:HealthStatus = "OK"   # OK, WARN, FAIL

# v13.2: Modal CLI - 2-mode toggle (OPS/PLAN) + explicit commands for RUN/SHIP
$Global:CurrentMode = "OPS"
$Global:LastPlanNote = $null
$Global:LastRunNote = $null
$Global:LastShipNote = $null

# SANDBOX UX: Router debug overlay toggle
$Global:RouterDebug = $false
$Global:LastRoutedCommand = $null

# Mode configuration (color, prompt, hint, default action)
$Global:ModeConfig = @{
    "OPS"  = @{ Color = "Cyan"; Prompt = "[OPS]"; Hint = "Monitor health & drift"; MicroHint = "OPS: ask 'health', 'drift', or type /ops" }
    "PLAN" = @{ Color = "Yellow"; Prompt = "[PLAN]"; Hint = "Describe work to plan"; MicroHint = "PLAN: describe what you want to build" }
    "RUN"  = @{ Color = "Magenta"; Prompt = "[RUN]"; Hint = "Execute & steer"; MicroHint = "RUN: give feedback or just press Enter" }
    "SHIP" = @{ Color = "Green"; Prompt = "[SHIP]"; Hint = "Release w/ confirm"; MicroHint = "SHIP: write notes, /ship --confirm to release" }
}
# v13.2.1: Only OPS/PLAN in Tab toggle (RUN/SHIP via explicit commands)
$Global:ModeRing = @("OPS", "PLAN")

function Get-FilteredCommands {
    param([string]$Filter)
    
    $filter = $Filter.TrimStart("/").ToLower()
    $filtered = @()
    
    foreach ($key in $Global:Commands.Keys) {
        if ($filter -eq "" -or $key.StartsWith($filter)) {
            $filtered += @{
                Name = $key
                Desc = $Global:Commands[$key].Desc
            }
        }
    }
    
    return $filtered
}

function Draw-CommandDropdown {
    param(
        [array]$Commands,
        [int]$SelectedIndex,
        [int]$ScrollOffset,
        [int]$StartRow
    )
    
    $colWidth = 38  # Width per column
    $numCols = 2    # Two columns side by side
    
    # Calculate rows needed (half the commands per column)
    $totalCmds = $Commands.Count
    $rowsNeeded = [Math]::Ceiling($totalCmds / $numCols)
    $visible = [Math]::Min($rowsNeeded, $Global:MaxVisible)
    
    # Calculate what's visible (by row, not by item)
    $startRow = $ScrollOffset
    $endRow = [Math]::Min($ScrollOffset + $visible, $rowsNeeded)
    
    # Draw dropdown frame
    $pos = $Host.UI.RawUI.CursorPosition
    
    for ($row = 0; $row -lt $visible; $row++) {
        $actualRow = $startRow + $row
        if ($actualRow -ge $rowsNeeded) { break }
        
        # Position cursor
        $Host.UI.RawUI.CursorPosition = @{ X = 0; Y = $StartRow + $row }
        
        # Draw both columns for this row
        for ($col = 0; $col -lt $numCols; $col++) {
            $idx = $actualRow + ($col * $rowsNeeded)
            
            if ($idx -lt $Commands.Count) {
                $cmd = $Commands[$idx]
                $isSelected = ($idx -eq $SelectedIndex)
                
                # Build line - shorter desc for 2-column layout
                $cmdName = ("/" + $cmd.Name).PadRight(12)
                $desc = $cmd.Desc
                if ($desc.Length -gt 22) { $desc = $desc.Substring(0, 19) + "..." }
                $desc = $desc.PadRight(22)
                
                if ($isSelected) {
                    Write-Host "‚ñ∂ " -NoNewline -ForegroundColor Cyan
                    Write-Host $cmdName -NoNewline -ForegroundColor Yellow
                    Write-Host $desc -NoNewline -ForegroundColor White
                }
                else {
                    Write-Host "  " -NoNewline
                    Write-Host $cmdName -NoNewline -ForegroundColor DarkYellow
                    Write-Host $desc -NoNewline -ForegroundColor DarkGray
                }
                
                # Add separator between columns
                if ($col -eq 0) {
                    Write-Host " ‚îÇ " -NoNewline -ForegroundColor DarkGray
                }
            }
            else {
                # Empty cell padding
                Write-Host (" " * $colWidth) -NoNewline
            }
        }
        Write-Host ""  # Newline at end of row
    }
    
    # Show scroll indicator if needed
    if ($rowsNeeded -gt $Global:MaxVisible) {
        $Host.UI.RawUI.CursorPosition = @{ X = 0; Y = $StartRow + $visible }
        $remaining = $rowsNeeded - $endRow
        if ($remaining -gt 0) {
            Write-Host "  ‚Üì$remaining more (use ‚Üë‚Üì arrows)" -ForegroundColor DarkGray
        }
        elseif ($ScrollOffset -gt 0) {
            Write-Host "  ‚Üë$ScrollOffset above (use ‚Üë‚Üì arrows)" -ForegroundColor DarkGray
        }
    }
    
    # Restore cursor
    $Host.UI.RawUI.CursorPosition = $pos
}

function Clear-DropdownArea {
    param([int]$StartRow, [int]$Lines)
    
    $pos = $Host.UI.RawUI.CursorPosition
    $width = $Host.UI.RawUI.WindowSize.Width
    
    for ($i = 0; $i -lt $Lines; $i++) {
        $Host.UI.RawUI.CursorPosition = @{ X = 0; Y = $StartRow + $i }
        Write-Host (" " * $width) -NoNewline
    }
    
    $Host.UI.RawUI.CursorPosition = $pos
}

function Show-CommandSuggestions {
    param([string]$Filter)
    
    # Remove leading slash
    $filter = $Filter.TrimStart("/").ToLower()
    
    Write-Host ""
    Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
    
    # Gather matching commands
    $matches = @()
    foreach ($key in $Global:Commands.Keys) {
        if ($filter -eq "" -or $key.StartsWith($filter)) {
            $matches += @{ Name = $key; Desc = $Global:Commands[$key].Desc }
        }
    }
    
    $maxShow = 16  # Show more since we have 2 columns (8 rows √ó 2)
    $rowsToShow = [Math]::Min([Math]::Ceiling($matches.Count / 2), 8)
    
    for ($row = 0; $row -lt $rowsToShow; $row++) {
        # Left column
        $leftIdx = $row
        # Right column
        $rightIdx = $row + $rowsToShow
        
        if ($leftIdx -lt $matches.Count -and $leftIdx -lt $maxShow) {
            $cmd = $matches[$leftIdx]
            $cmdDisplay = "/$($cmd.Name)".PadRight(12)
            $desc = $cmd.Desc
            if ($desc.Length -gt 22) { $desc = $desc.Substring(0, 19) + "..." }
            $desc = $desc.PadRight(22)
            Write-Host "  $cmdDisplay" -NoNewline -ForegroundColor Yellow
            Write-Host "$desc" -NoNewline -ForegroundColor Gray
        }
        else {
            Write-Host (" " * 36) -NoNewline
        }
        
        Write-Host " ‚îÇ " -NoNewline -ForegroundColor DarkGray
        
        if ($rightIdx -lt $matches.Count -and $rightIdx -lt $maxShow) {
            $cmd = $matches[$rightIdx]
            $cmdDisplay = "/$($cmd.Name)".PadRight(12)
            $desc = $cmd.Desc
            if ($desc.Length -gt 22) { $desc = $desc.Substring(0, 19) + "..." }
            Write-Host "$cmdDisplay" -NoNewline -ForegroundColor Yellow
            Write-Host "$desc" -ForegroundColor Gray
        }
        else {
            Write-Host ""
        }
    }
    
    if ($matches.Count -eq 0) {
        Write-Host "  (No matching commands for '/$filter')" -ForegroundColor DarkGray
    }
    elseif ($matches.Count -gt $maxShow) {
        Write-Host "  ... and $($matches.Count - $maxShow) more (keep typing to filter)" -ForegroundColor DarkGray
    }
    
    Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
}

# ============================================================================
# COMMAND EXECUTION
# ============================================================================

function Invoke-Continue {
    # Check for RED decisions (blockers)
    $redDecisions = Invoke-Query "SELECT id, question FROM decisions WHERE status='pending' AND priority='red' LIMIT 1"
    if ($redDecisions.Count -gt 0) {
        $dec = $redDecisions[0]
        Write-Host "  üî¥ BLOCKED: Decision required" -ForegroundColor Red
        Write-Host "     [$($dec.id)] $($dec.question)" -ForegroundColor Yellow
        Write-Host "     Use: /decide $($dec.id) <your answer>" -ForegroundColor Gray
        return
    }
    
    # Check for stuck tasks
    $stuckTasks = Invoke-Query "SELECT id, desc FROM tasks WHERE auditor_status='escalated' OR retry_count >= 3 LIMIT 1"
    if ($stuckTasks.Count -gt 0) {
        $stuck = $stuckTasks[0]
        Write-Host "  üî¥ STUCK: Auditor escalated task" -ForegroundColor Red
        Write-Host "     [$($stuck.id)] $($stuck.desc)" -ForegroundColor Yellow
        Write-Host "     Use: /reset $($stuck.id) after fixing manually" -ForegroundColor Gray
        return
    }
    
    # Get next pending task
    $nextTask = Invoke-Query "SELECT id, type, desc, strictness FROM tasks WHERE status='pending' ORDER BY priority DESC, id LIMIT 1"
    if ($nextTask.Count -eq 0) {
        Write-Host "  ‚úÖ Queue empty. All done!" -ForegroundColor Green
        return
    }
    
    $task = $nextTask[0]
    $strictness = if ($task.strictness) { $task.strictness.ToUpper() } else { "NORMAL" }
    $icon = switch ($strictness) { "CRITICAL" { "üî¥" } "RELAXED" { "üü¢" } default { "üü°" } }
    
    Write-Host "  ‚ñ∂ Executing [$icon $strictness]: [$($task.id)] $($task.desc)" -ForegroundColor Cyan
    Invoke-Query "UPDATE tasks SET status='in_progress', updated_at=strftime('%s','now') WHERE id=$($task.id)" | Out-Null
}

function Show-Stream {
    param([string]$Type)
    
    $logFile = Get-ChildItem "$LogDir\*-$Type.log" -ErrorAction SilentlyContinue | 
    Sort-Object LastWriteTime -Descending | Select-Object -First 1
    
    if (-not $logFile) {
        Write-Host "  No logs for $Type worker" -ForegroundColor Yellow
        return
    }
    
    Write-Host ""
    Write-Host "  ‚ïê‚ïê‚ïê $($Type.ToUpper()) WORKER STREAM ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
    Write-Host ""
    
    $lines = Get-Content $logFile.FullName -Tail 15 -ErrorAction SilentlyContinue
    foreach ($line in $lines) {
        Write-Host "  $line" -ForegroundColor Gray
    }
    
    Write-Host ""
    Write-Host "  Press Enter to continue..." -ForegroundColor DarkGray
    Read-Host | Out-Null
}

function Show-AuditLog {
    Write-Host ""
    Write-Host "  ‚ïê‚ïê‚ïê AUDIT LOG ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
    Write-Host ""
    
    $logs = Invoke-Query "SELECT task_id, action, strictness, reason, created_at FROM audit_log ORDER BY created_at DESC LIMIT 8"
    
    if ($logs.Count -eq 0) {
        Write-Host "  No audit entries yet" -ForegroundColor Gray
        return
    }
    
    foreach ($log in $logs) {
        $icon = switch ($log.action) { 'approve' { '‚úÖ' } 'reject' { 'üî¥' } 'escalate' { '‚ö†Ô∏è' } default { 'üìã' } }
        Write-Host "  $icon [$($log.task_id)] $($log.action.ToUpper()) - $($log.reason)" -ForegroundColor Gray
    }
}

function Show-Tasks {
    Write-Host ""
    Write-Host "  ‚ïê‚ïê‚ïê TASK LIST ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
    Write-Host ""
    
    $tasks = Invoke-Query "SELECT id, type, status, substr(desc,1,45) as d FROM tasks ORDER BY CASE status WHEN 'in_progress' THEN 1 WHEN 'pending' THEN 2 ELSE 3 END, id LIMIT 15"
    
    if ($tasks.Count -eq 0) {
        Write-Host "  No tasks in queue" -ForegroundColor Gray
        return
    }
    
    foreach ($task in $tasks) {
        $icon = switch ($task.status) { 'completed' { '‚úÖ' } 'in_progress' { '‚è≥' } 'pending' { '‚è∏Ô∏è' } 'failed' { '‚ùå' } default { 'üìã' } }
        $typeIcon = if ($task.type -eq 'backend') { 'BE' } else { 'FE' }
        Write-Host "  $icon [$($task.id)] [$typeIcon] $($task.d)" -ForegroundColor $(if ($task.status -eq 'in_progress') { 'Cyan' } else { 'Gray' })
    }
}

function Show-Plan {
    Write-Host ""
    Write-Host "  ‚ïê‚ïê‚ïê ROADMAP ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
    Write-Host ""
    
    Write-Host "  BACKEND:" -ForegroundColor Yellow
    $beTasks = Invoke-Query "SELECT id, substr(desc,1,50) as d FROM tasks WHERE type='backend' AND status='pending' ORDER BY priority DESC, id LIMIT 5"
    if ($beTasks.Count -eq 0) { Write-Host "    (empty)" -ForegroundColor Gray }
    foreach ($t in $beTasks) { Write-Host "    ‚Üí [$($t.id)] $($t.d)" -ForegroundColor Gray }
    
    Write-Host ""
    Write-Host "  FRONTEND:" -ForegroundColor Yellow
    $feTasks = Invoke-Query "SELECT id, substr(desc,1,50) as d FROM tasks WHERE type='frontend' AND status='pending' ORDER BY priority DESC, id LIMIT 5"
    if ($feTasks.Count -eq 0) { Write-Host "    (empty)" -ForegroundColor Gray }
    foreach ($t in $feTasks) { Write-Host "    ‚Üí [$($t.id)] $($t.d)" -ForegroundColor Gray }
}

function Invoke-SlashCommand {
    param([string]$UserInput)
    
    # Parse command and cmdArgs
    $parts = $UserInput.TrimStart("/").Split(" ", 2)
    $cmd = $parts[0].ToLower()
    $cmdArgs = if ($parts.Count -gt 1) { $parts[1].Trim() } else { "" }
    
    # Check for aliases (track original for deprecation warnings)
    $originalCmd = $cmd
    foreach ($key in $Global:Commands.Keys) {
        $aliases = $Global:Commands[$key].Alias
        if ($aliases -and $aliases -contains $cmd) {
            $cmd = $key
            break
        }
    }
    
    switch ($cmd) {
        # === SESSION ===
        "quit" { 
            Write-Host "  üëã Goodbye!" -ForegroundColor Yellow
            exit 
        }
        "clear" { 
            Clear-Host
            return "refresh"
        }
        "refresh" { 
            return "refresh" 
        }
        "router-debug" {
            $Global:RouterDebug = -not $Global:RouterDebug
            $status = if ($Global:RouterDebug) { "ENABLED" } else { "DISABLED" }
            Write-Host ""
            Write-Host "  üîç Router Debug $status" -ForegroundColor $(if ($Global:RouterDebug) { "Green" } else { "Yellow" })
            Write-Host "     Debug overlay will show routing decisions above input bar" -ForegroundColor DarkGray
            Write-Host ""
            return "refresh"
        }
        "help" {
            # v13.3.1: Scenario-first help
            if ($cmdArgs -eq "--all") {
                $catalog = Get-CommandCatalog -ShowAll $true
                Write-Host ""
                Write-Host "  ‚ïê‚ïê‚ïê ALL COMMANDS ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
                Write-Host ""
                Write-Host "  GOLDEN PATH" -ForegroundColor Yellow
                foreach ($cmd in $catalog.GoldenPath) {
                    Write-Host "    /$($cmd.Name)".PadRight(18) -NoNewline -ForegroundColor Yellow
                    Write-Host $cmd.Desc -ForegroundColor Gray
                }
                Write-Host ""
                Write-Host "  ADVANCED" -ForegroundColor DarkYellow
                foreach ($cmd in $catalog.Advanced) {
                    Write-Host "    /$($cmd.Name)".PadRight(18) -NoNewline -ForegroundColor DarkGray
                    Write-Host $cmd.Desc -ForegroundColor DarkGray
                }
                Write-Host ""
                Write-Host "  SESSION" -ForegroundColor DarkCyan
                foreach ($cmd in $catalog.Session) {
                    Write-Host "    /$($cmd.Name)".PadRight(18) -NoNewline -ForegroundColor DarkGray
                    Write-Host $cmd.Desc -ForegroundColor DarkGray
                }
                Write-Host ""
                Write-Host "  DEPRECATED" -ForegroundColor DarkRed
                foreach ($cmd in $catalog.Deprecated) {
                    Write-Host "    /$($cmd.Name)".PadRight(18) -NoNewline -ForegroundColor DarkRed
                    Write-Host $cmd.Desc -ForegroundColor DarkGray
                }
                Write-Host ""
            }
            else {
                # Default: Scenario-first help (use-cases, not command catalog)
                Write-Host ""
                Write-Host "  What do you want to do?" -ForegroundColor Cyan
                Write-Host ""
                Write-Host "  1) " -NoNewline -ForegroundColor White
                Write-Host "Start a new project" -ForegroundColor Yellow
                Write-Host "     Run: " -NoNewline -ForegroundColor DarkGray
                Write-Host "/init" -ForegroundColor Cyan
                Write-Host "     Or type: " -NoNewline -ForegroundColor DarkGray
                Write-Host "'start a payments service'" -ForegroundColor Gray
                Write-Host ""
                Write-Host "  2) " -NoNewline -ForegroundColor White
                Write-Host "Continue working" -ForegroundColor Yellow
                Write-Host "     Run: " -NoNewline -ForegroundColor DarkGray
                Write-Host "/ops" -NoNewline -ForegroundColor Cyan
                Write-Host " (status) ‚Üí " -NoNewline -ForegroundColor DarkGray
                Write-Host "/plan" -NoNewline -ForegroundColor Cyan
                Write-Host " (roadmap) ‚Üí " -NoNewline -ForegroundColor DarkGray
                Write-Host "/run" -ForegroundColor Cyan
                Write-Host ""
                Write-Host "  3) " -NoNewline -ForegroundColor White
                Write-Host "Ship a release" -ForegroundColor Yellow
                Write-Host "     Run: " -NoNewline -ForegroundColor DarkGray
                Write-Host "/ship" -NoNewline -ForegroundColor Cyan
                Write-Host " (preflight, no auto-deploy)" -ForegroundColor DarkGray
                Write-Host ""
                Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
                Write-Host "  /help --all" -NoNewline -ForegroundColor DarkCyan
                Write-Host "  Full command registry" -ForegroundColor DarkGray
                Write-Host ""
            }
        }

        # === LEGACY ALIAS ===
        "commands" {
            Write-Host ""
            Write-Host "  ‚ö†Ô∏è  /commands is legacy. Use /help or /help --all" -ForegroundColor DarkYellow
            Write-Host ""
            # Show /help --all output
            $catalog = Get-CommandCatalog -ShowAll $true
            Write-Host "  ‚ïê‚ïê‚ïê ALL COMMANDS ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
            Write-Host ""
            Write-Host "  GOLDEN PATH (beginner-safe)" -ForegroundColor Yellow
            foreach ($c in $catalog.GoldenPath) {
                Write-Host "    /$($c.Name)".PadRight(20) -NoNewline -ForegroundColor Yellow
                Write-Host $c.Desc -ForegroundColor Gray
            }
            Write-Host ""
            Write-Host "  ADVANCED" -ForegroundColor DarkYellow
            foreach ($c in $catalog.Advanced) {
                Write-Host "    /$($c.Name)".PadRight(20) -NoNewline -ForegroundColor DarkGray
                Write-Host $c.Desc -ForegroundColor DarkGray
            }
            Write-Host ""
            Write-Host "  SESSION" -ForegroundColor DarkCyan
            foreach ($c in $catalog.Session) {
                Write-Host "    /$($c.Name)".PadRight(20) -NoNewline -ForegroundColor DarkGray
                Write-Host $c.Desc -ForegroundColor DarkGray
            }
            Write-Host ""
            Write-Host "  DEPRECATED" -ForegroundColor DarkRed
            foreach ($c in $catalog.Deprecated) {
                Write-Host "    /$($c.Name)".PadRight(20) -NoNewline -ForegroundColor DarkRed
                Write-Host $c.Desc -ForegroundColor DarkGray
            }
            Write-Host ""
        }

        # === EXECUTION ===
        "go" {
            # Only show deprecation if user typed /go (not /run or /c)
            if ($originalCmd -eq "go") {
                Write-Host "  ‚ö†Ô∏è  Deprecated: prefer /run or natural language" -ForegroundColor DarkYellow
            }
            Invoke-Continue
        }

        # === TASK MANAGEMENT (DEPRECATED - use natural language) ===
        "add" {
            Write-Host "  ‚ö†Ô∏è  Deprecated: prefer 'add backend task ...' in natural language" -ForegroundColor DarkYellow
            if ($cmdArgs -match "^(backend|frontend)\s+(.+)$") {
                $type = $Matches[1]
                $desc = $Matches[2]
                $now = [int](Get-Date -UFormat %s)
                Invoke-Query "INSERT INTO tasks (type, desc, status, updated_at) VALUES ('$type', '$desc', 'pending', $now)" | Out-Null
                Write-Host "  ‚úÖ Added $type task: $desc" -ForegroundColor Green
            }
            else {
                Write-Host "  Usage: /add backend|frontend <description>" -ForegroundColor Yellow
            }
        }
        "skip" {
            Write-Host "  ‚ö†Ô∏è  Deprecated: prefer 'skip T-123' in natural language" -ForegroundColor DarkYellow
            if ($cmdArgs -match "^\d+$") {
                Invoke-Query "UPDATE tasks SET status='skipped' WHERE id=$cmdArgs" | Out-Null
                Write-Host "  ‚è≠Ô∏è Skipped task #$cmdArgs" -ForegroundColor Yellow
            }
            else {
                Write-Host "  Usage: /skip <task_id>" -ForegroundColor Yellow
            }
        }
        "reset" {
            if ($cmdArgs -match "^\d+$") {
                Invoke-Query "UPDATE tasks SET retry_count=0, auditor_status='pending', auditor_feedback='[]', status='pending' WHERE id=$cmdArgs" | Out-Null
                Write-Host "  üîÑ Reset task #$cmdArgs" -ForegroundColor Green
            }
            else {
                Write-Host "  Usage: /reset <task_id>" -ForegroundColor Yellow
            }
        }
        "drop" {
            Write-Host "  ‚ö†Ô∏è  Deprecated: prefer 'delete task T-123' in natural language" -ForegroundColor DarkYellow
            if ($cmdArgs -match "^\d+$") {
                Invoke-Query "DELETE FROM tasks WHERE id=$cmdArgs" | Out-Null
                Write-Host "  üóëÔ∏è Deleted task #$cmdArgs" -ForegroundColor Red
            }
            else {
                Write-Host "  Usage: /drop <task_id>" -ForegroundColor Yellow
            }
        }
        "nuke" {
            if ($args -eq "--confirm") {
                Invoke-Query "DELETE FROM tasks WHERE status='pending'" | Out-Null
                Write-Host "  üí• All pending tasks cleared" -ForegroundColor Red
            }
            else {
                Write-Host "  ‚ö†Ô∏è This will delete ALL pending tasks!" -ForegroundColor Red
                Write-Host "  Type: /nuke --confirm" -ForegroundColor Yellow
            }
        }
        
        # === AGENTS ===
        "audit" { Show-AuditLog }
        "lib" {
            $action = if ($args) { $args.Split(" ")[0] } else { "status" }
            switch ($action) {
                "scan" { 
                    # Gap #4 Fix: Git Guard
                    $gitStatus = git status --porcelain 2>&1
                    if (-not [string]::IsNullOrWhiteSpace($gitStatus)) {
                        Write-Host "  üî¥ BLOCKED: Git working tree is dirty." -ForegroundColor Red
                        Write-Host "     Commit or stash changes before running Librarian." -ForegroundColor Gray
                        Write-Host ""
                        Write-Host "     Changed files:" -ForegroundColor Yellow
                        $gitStatus -split "`n" | ForEach-Object { Write-Host "       $_" -ForegroundColor DarkGray }
                        return
                    }
                    
                    Write-Host "  üìö Starting Librarian scan..." -ForegroundColor Cyan
                    Write-Host "  (Use MCP tool: librarian_scan)" -ForegroundColor Gray
                }
                "status" {
                    $ops = Invoke-Query "SELECT status, COUNT(*) as c FROM librarian_ops GROUP BY status"
                    Write-Host "  üìö Librarian Status:" -ForegroundColor Cyan
                    foreach ($op in $ops) { Write-Host "    $($op.status): $($op.c)" -ForegroundColor Gray }
                }
                "mount" {
                    # Mount external reference project via symlink
                    $parts = $action_args -split "\s+", 2
                    $name = $parts[0]
                    $targetPath = if ($parts.Count -gt 1) { $parts[1] } else { "" }
                    
                    if (-not $name -or -not $targetPath) {
                        Write-Host "  Usage: /lib mount <name> <path>" -ForegroundColor Yellow
                        Write-Host "  Example: /lib mount context7 E:\Code\reference-project" -ForegroundColor Gray
                        return
                    }
                    
                    $refsPath = Join-Path $RepoRoot "library\references"
                    $linkPath = Join-Path $refsPath $name
                    
                    if (-not (Test-Path $targetPath)) {
                        Write-Host "  ‚ö†Ô∏è Target path does not exist: $targetPath" -ForegroundColor Yellow
                        return
                    }
                    
                    if (Test-Path $linkPath) {
                        Write-Host "  ‚ö†Ô∏è '$name' already mounted. Use /lib unmount $name first." -ForegroundColor Yellow
                        return
                    }
                    
                    try {
                        # Create junction (symlink alternative that doesn't need admin)
                        New-Item -ItemType Junction -Path $linkPath -Target $targetPath | Out-Null
                        Write-Host "  ‚úÖ Mounted '$name' ‚Üí $targetPath" -ForegroundColor Green
                        Write-Host "  Agents can now access: library/references/$name" -ForegroundColor Gray
                    }
                    catch {
                        Write-Host "  ‚ö†Ô∏è Failed to create junction. Try running as Admin." -ForegroundColor Yellow
                        Write-Host "  Or manually: New-Item -ItemType Junction -Path '$linkPath' -Target '$targetPath'" -ForegroundColor Gray
                    }
                }
                "unmount" {
                    $name = $action_args
                    if (-not $name) {
                        Write-Host "  Usage: /lib unmount <name>" -ForegroundColor Yellow
                        return
                    }
                    
                    $linkPath = Join-Path $RepoRoot "library\references\$name"
                    
                    if (-not (Test-Path $linkPath)) {
                        Write-Host "  ‚ö†Ô∏è '$name' is not mounted" -ForegroundColor Yellow
                        return
                    }
                    
                    try {
                        # Remove junction (use cmd's rmdir to safely remove junction without deleting target)
                        cmd /c "rmdir `"$linkPath`"" 2>$null
                        Write-Host "  ‚úÖ Unmounted '$name'" -ForegroundColor Green
                    }
                    catch {
                        Write-Host "  ‚ö†Ô∏è Failed to unmount. Try: cmd /c rmdir '$linkPath'" -ForegroundColor Yellow
                    }
                }
                "refs" {
                    # List mounted references
                    $refsPath = Join-Path $RepoRoot "library\references"
                    Write-Host ""
                    Write-Host "  ‚ïê‚ïê‚ïê MOUNTED REFERENCES ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
                    Write-Host ""
                    
                    $items = Get-ChildItem $refsPath -Directory -ErrorAction SilentlyContinue
                    if ($items) {
                        foreach ($item in $items) {
                            $isJunction = (Get-Item $item.FullName).Attributes -band [IO.FileAttributes]::ReparsePoint
                            $icon = if ($isJunction) { "üîó" } else { "üìÅ" }
                            $target = if ($isJunction) {
                                try { (Get-Item $item.FullName).Target } catch { "‚Üí (junction)" }
                            }
                            else { "(local)" }
                            
                            Write-Host "    $icon $($item.Name)" -NoNewline -ForegroundColor Yellow
                            Write-Host " $target" -ForegroundColor Gray
                        }
                    }
                    else {
                        Write-Host "    (No references mounted)" -ForegroundColor Gray
                    }
                    
                    Write-Host ""
                    Write-Host "  Mount with: /lib mount <name> <path>" -ForegroundColor Gray
                }
                default { Write-Host "  Usage: /lib scan|status|mount|unmount|refs" -ForegroundColor Yellow }
            }
        }
        
        # === v9.1 AIR GAP INGESTION ===
        "ingest" {
            Write-Host ""
            Write-Host "  üì• AIR GAP INGESTION" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            
            $inboxPath = Join-Path $CurrentDir "docs\inbox"
            
            # Check if inbox exists
            if (-not (Test-Path $inboxPath)) {
                New-Item -ItemType Directory -Path $inboxPath -Force | Out-Null
                Write-Host "  üìÅ Created docs/inbox/ folder" -ForegroundColor Gray
            }
            
            # Count files in inbox
            $files = Get-ChildItem $inboxPath -File -ErrorAction SilentlyContinue | Where-Object { -not $_.Name.StartsWith(".") }
            
            if ($files.Count -eq 0) {
                Write-Host "  üì≠ Inbox is empty." -ForegroundColor Yellow
                Write-Host ""
                Write-Host "  TIP: Drop raw PRDs, meeting notes, or requirements" -ForegroundColor Gray
                Write-Host "       into docs/inbox/ and run /ingest again." -ForegroundColor Gray
            }
            else {
                Write-Host "  Found $($files.Count) file(s) to process:" -ForegroundColor White
                foreach ($f in $files | Select-Object -First 5) {
                    Write-Host "    ‚Ä¢ $($f.Name)" -ForegroundColor Gray
                }
                if ($files.Count -gt 5) {
                    Write-Host "    ... and $($files.Count - 5) more" -ForegroundColor DarkGray
                }
                Write-Host ""
                
                # Call Python ingest function
                Write-Host "  üîÑ Compiling specs..." -ForegroundColor Yellow
                try {
                    $result = python -c "import asyncio; from product_owner import ingest_inbox; print(asyncio.run(ingest_inbox()))" 2>&1
                    Write-Host "  $result" -ForegroundColor Green
                }
                catch {
                    Write-Host "  ‚ö†Ô∏è Ingestion error: $_" -ForegroundColor Red
                }
            }
            Write-Host ""
        }
        
        # === v9.6 PHASE-DRIVEN RIGOR (Status Only) ===
        "rigor" {
            Write-Host ""
            Write-Host "  ‚öôÔ∏è PHASE-DRIVEN RIGOR (v9.6)" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            Write-Host ""
            Write-Host "  Rigor is now AUTOMATIC - derived from Mode + Risk" -ForegroundColor White
            Write-Host ""
            
            # Get current mode
            $mode = "vibe"
            try {
                $modeResult = Invoke-Query "SELECT value FROM config WHERE key='mode'" -Silent
                if ($modeResult) { $mode = $modeResult[0].value }
            }
            catch {}
            
            $modeIcon = switch ($mode) {
                "vibe" { "üü¢" }
                "converge" { "ÔøΩ" }
                "ship" { "ÔøΩ" }
                default { "‚ö™" }
            }
            
            Write-Host "  Current Mode: $modeIcon $($mode.ToUpper())" -ForegroundColor Cyan
            Write-Host ""
            
            # Show the Phase x Risk Matrix
            Write-Host "  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor DarkGray
            Write-Host "  ‚îÇ Mode\Risk‚îÇ  LOW    ‚îÇ MEDIUM  ‚îÇ  HIGH    ‚îÇ" -ForegroundColor DarkGray
            Write-Host "  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor DarkGray
            
            # VIBE row
            $vibeColor = if ($mode -eq "vibe") { "Yellow" } else { "Gray" }
            Write-Host "  ‚îÇ VIBE     ‚îÇ SPIKE   ‚îÇ SPIKE   ‚îÇ IRONCLAD ‚îÇ" -ForegroundColor $vibeColor
            
            # CONVERGE row
            $convColor = if ($mode -eq "converge") { "Yellow" } else { "Gray" }
            Write-Host "  ‚îÇ CONVERGE ‚îÇ SPIKE   ‚îÇ BUILD   ‚îÇ IRONCLAD ‚îÇ" -ForegroundColor $convColor
            
            # SHIP row
            $shipColor = if ($mode -eq "ship") { "Yellow" } else { "Gray" }
            Write-Host "  ‚îÇ SHIP     ‚îÇ BUILD   ‚îÇ IRONCLAD‚îÇ IRONCLAD ‚îÇ" -ForegroundColor $shipColor
            
            Write-Host "  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor DarkGray
            Write-Host ""
            Write-Host "  Override: Add [L1], [L2], or [L3] to task description" -ForegroundColor Gray
            Write-Host "  Example:  /add backend 'Quick UI fix [L1]'" -ForegroundColor DarkGray
            Write-Host "  Example:  /add backend 'Refactor auth [L3]'" -ForegroundColor DarkGray
            Write-Host ""
        }
        
        # === v9.7 CORE LOCK ===
        "unlock" {
            Write-Host ""
            $scope = if ($cmdArgs -eq "session") { "session" } else { "next_task" }
            
            try {
                $result = python -c "from dynamic_rigor import unlock_core; print(unlock_core('$scope', 'cli_user'))" 2>&1
                Write-Host "  $result" -ForegroundColor Green
                
                if ($scope -eq "next_task") {
                    Write-Host ""
                    Write-Host "  Protected paths temporarily UNLOCKED:" -ForegroundColor Yellow
                    Write-Host "    core/, auth/, security/, migrations/, .env" -ForegroundColor Gray
                    Write-Host ""
                    Write-Host "  ‚ö†Ô∏è Auto-locks after next task completes" -ForegroundColor Yellow
                }
                else {
                    Write-Host ""
                    Write-Host "  ‚ö†Ô∏è Session unlock - use /lock to re-lock" -ForegroundColor Red
                }
            }
            catch {
                Write-Host "  ‚ùå Failed to unlock: $_" -ForegroundColor Red
            }
            Write-Host ""
        }
        
        "lock" {
            Write-Host ""
            try {
                $result = python -c "from dynamic_rigor import lock_core; print(lock_core())" 2>&1
                Write-Host "  $result" -ForegroundColor Cyan
                Write-Host ""
                Write-Host "  Protected paths: core/, auth/, security/, migrations/, .env" -ForegroundColor Gray
            }
            catch {
                Write-Host "  ‚ùå Failed to lock: $_" -ForegroundColor Red
            }
            Write-Host ""
        }
        
        # === v9.8 CLARIFICATION ===
        "questions" {
            Write-Host ""
            Write-Host "  üìã CLARIFICATION QUEUE (v9.8)" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            
            try {
                $result = python -c "from dynamic_rigor import get_open_questions; import json; qs = get_open_questions(); print(json.dumps(qs))" 2>&1
                $questions = $result | ConvertFrom-Json -ErrorAction SilentlyContinue
                
                if ($questions -and $questions.Count -gt 0) {
                    Write-Host ""
                    Write-Host "  OPEN QUESTIONS ($($questions.Count)):" -ForegroundColor Yellow
                    Write-Host ""
                    
                    foreach ($q in $questions) {
                        $round = $q.round
                        $focus = switch ($round) {
                            1 { "Requirements" }
                            2 { "Edge Cases" }
                            3 { "Architecture" }
                            default { "General" }
                        }
                        Write-Host "  $($q.id) [Round $round - $focus]" -ForegroundColor White
                        if ($q.question) {
                            Write-Host "    $($q.question)" -ForegroundColor Gray
                        }
                        Write-Host ""
                    }
                    
                    Write-Host "  Answer with: /answer Qn 'your answer'" -ForegroundColor DarkGray
                }
                else {
                    Write-Host ""
                    Write-Host "  ‚úÖ No open questions" -ForegroundColor Green
                    Write-Host "  Status: READY" -ForegroundColor Cyan
                }
            }
            catch {
                Write-Host "  ‚ùå Failed to get questions: $_" -ForegroundColor Red
            }
            Write-Host ""
        }
        
        "answer" {
            Write-Host ""
            
            if ($cmdArgs -match "^(Q\d+)\s+['""]?(.+?)['""]?$") {
                $qid = $Matches[1]
                $answerText = $Matches[2]
                
                try {
                    # Mark closed and patch spec
                    $result = python -c "from dynamic_rigor import mark_question_closed, patch_active_spec, count_open_questions; closed = mark_question_closed('$qid', '''$answerText'''); patched = patch_active_spec('$qid', '''$answerText'''); remaining = count_open_questions(); print(f'{closed}|{patched}|{remaining}')" 2>&1
                    
                    $parts = $result -split '\|'
                    $closed = $parts[0] -eq "True"
                    $patched = $parts[1] -eq "True"
                    $remaining = [int]$parts[2]
                    
                    if ($closed) {
                        Write-Host "  ‚úÖ $qid resolved." -ForegroundColor Green
                        if ($patched) {
                            Write-Host "  üìù ACTIVE_SPEC.md patched." -ForegroundColor Cyan
                        }
                        
                        if ($remaining -eq 0) {
                            Write-Host ""
                            Write-Host "  ‚ñ∂Ô∏è All questions answered - Ready to resume!" -ForegroundColor Green
                        }
                        else {
                            Write-Host ""
                            Write-Host "  $remaining question(s) remaining. Use /questions to view." -ForegroundColor Yellow
                        }
                    }
                    else {
                        Write-Host "  ‚ùå Question $qid not found" -ForegroundColor Red
                    }
                }
                catch {
                    Write-Host "  ‚ùå Failed to answer: $_" -ForegroundColor Red
                }
            }
            else {
                Write-Host "  Usage: /answer Q1 'your answer here'" -ForegroundColor Yellow
                Write-Host "  Example: /answer Q1 'Use JWT with 24h expiry'" -ForegroundColor DarkGray
            }
            Write-Host ""
        }
        
        # === v9.9 REVIEWER ===
        "review" {
            Write-Host ""
            Write-Host "  üëÅÔ∏è CODE REVIEW STATUS (v9.9)" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            
            $taskId = if ($cmdArgs) { $cmdArgs } else { "current" }
            
            try {
                if ($taskId -eq "current") {
                    # Get active task
                    $stateResult = python -c "from dynamic_rigor import get_active_task; import json; t = get_active_task(); print(json.dumps(t) if t else 'null')" 2>&1
                    if ($stateResult -ne "null") {
                        $task = $stateResult | ConvertFrom-Json -ErrorAction SilentlyContinue
                        if ($task) { $taskId = $task.id }
                    }
                }
                
                if ($taskId -and $taskId -ne "current") {
                    $reviewResult = python -c "from dynamic_rigor import get_review_status; import json; print(json.dumps(get_review_status('$taskId')))" 2>&1
                    $review = $reviewResult | ConvertFrom-Json -ErrorAction SilentlyContinue
                    
                    if ($review.reviewed) {
                        $statusColor = if ($review.status -eq "PASS") { "Green" } else { "Red" }
                        Write-Host ""
                        Write-Host "  Task: $taskId" -ForegroundColor White
                        Write-Host "  Status: $($review.status)" -ForegroundColor $statusColor
                        if ($review.issues_count -gt 0) {
                            Write-Host "  Issues: $($review.issues_count)" -ForegroundColor Yellow
                        }
                        Write-Host "  File: $($review.path)" -ForegroundColor Gray
                    }
                    else {
                        Write-Host ""
                        Write-Host "  Task $taskId has not been reviewed yet" -ForegroundColor Yellow
                        Write-Host "  Review happens automatically after code generation" -ForegroundColor Gray
                    }
                }
                else {
                    Write-Host ""
                    Write-Host "  No active task. Use: /review <task_id>" -ForegroundColor Yellow
                }
            }
            catch {
                Write-Host "  ‚ùå Failed to get review: $_" -ForegroundColor Red
            }
            Write-Host ""
        }
        
        "rules" {
            Write-Host ""
            Write-Host "  üìú DOMAIN RULES (v9.9)" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            Write-Host ""
            
            $rulesPath = Join-Path (Get-Location) "docs\DOMAIN_RULES.md"
            if (Test-Path $rulesPath) {
                $rules = Get-Content $rulesPath -Raw
                # Just show the first 30 lines
                $lines = $rules -split "`n" | Select-Object -First 30
                foreach ($line in $lines) {
                    Write-Host "  $line" -ForegroundColor Gray
                }
                Write-Host ""
                Write-Host "  ... (see docs/DOMAIN_RULES.md for full list)" -ForegroundColor DarkGray
            }
            else {
                Write-Host "  No domain rules defined yet." -ForegroundColor Yellow
                Write-Host "  Create: docs/DOMAIN_RULES.md" -ForegroundColor Gray
            }
            Write-Host ""
        }
        
        # === v9.9 COLLECTIVE MEMORY ===
        "incident" {
            if ($cmdArgs) {
                Call-MeshTool "log_incident" @{ symptom = $cmdArgs; trigger = "Manual Report"; severity = "MEDIUM" }
            }
            else {
                Write-Host "  Usage: /incident `"System crashed 500 error`"" -ForegroundColor Yellow
            }
        }
        
        "mine" {
            Write-Host "‚õèÔ∏è  Starting Pattern Miner..." -ForegroundColor Cyan
            # The tool executes and we print the result
            Call-MeshTool "run_pattern_miner" @{}
        }
        
        "patterns" {
            Write-Host ""
            Write-Host "  üìö PATTERN LIBRARY (v9.9)" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            $patPath = Join-Path (Get-Location) "docs\PATTERNS_LIBRARY.md"
            if (Test-Path $patPath) {
                $pats = Get-Content $patPath -Tail 20
                foreach ($line in $pats) { Write-Host "  $line" -ForegroundColor Gray }
            }
            else {
                Write-Host "  No patterns mined yet." -ForegroundColor Yellow
            }
            Write-Host ""
        }

        # === v13.2 TDD ===
        "scaffold-tests" {
            if ($cmdArgs) {
                Write-Host "  üèóÔ∏è  Generating test scaffold for task: $cmdArgs" -ForegroundColor Cyan
                Call-MeshTool "scaffold_tests" @{ task_id = $cmdArgs }
            }
            else {
                Write-Host "  Usage: /scaffold-tests <task_id>" -ForegroundColor Yellow
            }
        }
        
        # === STREAMS ===
        "stream" {
            if ($args -eq "backend" -or $args -eq "be") { Show-Stream "backend" }
            elseif ($args -eq "frontend" -or $args -eq "fe") { Show-Stream "frontend" }
            else { Write-Host "  Usage: /stream backend|frontend" -ForegroundColor Yellow }
        }
        
        # === CONTEXT ===
        "decide" {
            if ($args -match "^(\d+)\s+(.+)$") {
                $id = $Matches[1]
                $answer = $Matches[2]
                Invoke-Query "UPDATE decisions SET answer='$answer', status='resolved' WHERE id=$id" | Out-Null
                Write-Host "  ‚úÖ Decision #$id resolved" -ForegroundColor Green
            }
            else {
                Write-Host "  Usage: /decide <id> <answer>" -ForegroundColor Yellow
            }
        }
        "note" {
            if ($args) {
                $notesFile = "$DocsDir\NOTES.md"
                $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm"
                Add-Content -Path $notesFile -Value "`n## $timestamp`n$args`n"
                Write-Host "  üìù Note added" -ForegroundColor Green
            }
            else {
                Write-Host "  Usage: /note <text>" -ForegroundColor Yellow
            }
        }
        "blocker" {
            if ($args) {
                $now = [int](Get-Date -UFormat %s)
                Invoke-Query "INSERT INTO decisions (priority, question, status, created_at) VALUES ('red', '$args', 'pending', $now)" | Out-Null
                Write-Host "  üî¥ Blocker added" -ForegroundColor Red
            }
            else {
                Write-Host "  Usage: /blocker <text>" -ForegroundColor Yellow
            }
        }
        
        # === CONFIGURATION ===
        "mode" {
            if ($cmdArgs -match "^(vibe|converge|ship)$") {
                Invoke-Query "UPDATE config SET value='$cmdArgs' WHERE key='mode'" | Out-Null
                Write-Host "  üîß Mode set to $($cmdArgs.ToUpper())" -ForegroundColor Green
            }
            else {
                $proj = Get-ProjectMode
                Write-Host "  Current mode: $($proj.Icon) $($proj.Mode)" -ForegroundColor White
                if ($null -ne $proj.Days) { Write-Host "  Days to milestone: $($proj.Days)" -ForegroundColor Gray }
                Write-Host "  Set with: /mode vibe|converge|ship" -ForegroundColor Gray
            }
        }
        "milestone" {
            if ($cmdArgs -match "^\d{4}-\d{2}-\d{2}$") {
                Set-Content -Path $MilestoneFile -Value $cmdArgs
                Write-Host "  üìÖ Milestone set to $cmdArgs" -ForegroundColor Green
            }
            else {
                Write-Host "  Usage: /milestone YYYY-MM-DD" -ForegroundColor Yellow
            }
        }
        
        # === MULTI-PROJECT ===
        "projects" {
            $configPath = Join-Path $RepoRoot "config\projects.json"
            if (Test-Path $configPath) {
                $projects = Get-Content $configPath | ConvertFrom-Json
                Write-Host ""
                Write-Host "  ‚ïê‚ïê‚ïê AVAILABLE PROJECTS ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
                Write-Host ""
                foreach ($p in $projects) {
                    Write-Host "  [$($p.id)] ".PadRight(7) -NoNewline -ForegroundColor Yellow
                    Write-Host "$($p.name)".PadRight(25) -NoNewline -ForegroundColor White
                    Write-Host "$($p.path)" -ForegroundColor DarkGray
                }
                Write-Host ""
                Write-Host "  Use: /multi 1 2 3  to launch grid" -ForegroundColor Gray
            }
            else {
                Write-Host "  ‚ö†Ô∏è No projects.json found at $configPath" -ForegroundColor Yellow
            }
        }
        "multi" {
            $configPath = Join-Path $RepoRoot "config\projects.json"
            $launcherPath = Join-Path $RepoRoot "launcher\mesh-up.ps1"
            
            if (-not (Test-Path $configPath)) {
                Write-Host "  ‚ö†Ô∏è No projects.json found" -ForegroundColor Yellow
                return
            }
            
            $projects = Get-Content $configPath | ConvertFrom-Json
            
            # Show projects if no args
            if ([string]::IsNullOrWhiteSpace($cmdArgs)) {
                Write-Host ""
                Write-Host "  ‚ïê‚ïê‚ïê SELECT PROJECTS FOR GRID ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
                Write-Host ""
                foreach ($p in $projects) {
                    Write-Host "  [$($p.id)] ".PadRight(7) -NoNewline -ForegroundColor Yellow
                    Write-Host "$($p.name)" -ForegroundColor White
                }
                Write-Host ""
                Write-Host "  Enter IDs (e.g. '1 2' or '1 2 3 4'): " -NoNewline -ForegroundColor Green
                $cmdArgs = Read-Host
            }
            
            # Parse IDs
            $ids = $cmdArgs -split "\s+" | Where-Object { $_ -match "^\d+$" } | ForEach-Object { [int]$_ }
            
            if ($ids.Count -eq 0) {
                Write-Host "  ‚ö†Ô∏è No valid project IDs provided" -ForegroundColor Yellow
                return
            }
            
            if ($ids.Count -gt 4) {
                Write-Host "  ‚ö†Ô∏è Maximum 4 projects supported" -ForegroundColor Yellow
                $ids = $ids[0..3]
            }
            
            Write-Host ""
            Write-Host "  üöÄ Launching Mission Control Grid..." -ForegroundColor Cyan
            
            # Launch the grid
            if (Test-Path $launcherPath) {
                $idStr = $ids -join ","
                Start-Process powershell.exe -ArgumentList "-File `"$launcherPath`" -Ids $idStr"
            }
            else {
                Write-Host "  ‚ö†Ô∏è Launcher not found at $launcherPath" -ForegroundColor Yellow
            }
        }
        
        # === LIBRARY (v13.3.1 - New Project Entry Point) ===
        "init" {
            Write-Host ""
            Write-Host "  üöÄ NEW PROJECT SETUP" -ForegroundColor Cyan
            Write-Host ""

            # If args provided, this is a quick-start: bootstrap + /work
            if ($cmdArgs) {
                Write-Host "  Quick start: '$cmdArgs'" -ForegroundColor Yellow
                Write-Host ""
            }

            # Detect profile using Python
            $detectedProfile = "general"
            try {
                $pyScript = @"
import sys
sys.path.insert(0, r'$RepoRoot')
from mesh_server import detect_project_profile
print(detect_project_profile(r'$CurrentDir'))
"@
                $detectedProfile = $pyScript | python 2>$null
                if (-not $detectedProfile) { $detectedProfile = "general" }
                $detectedProfile = $detectedProfile.Trim()
            }
            catch {
                Write-Host "  ‚ö†Ô∏è Detection failed, using 'general'" -ForegroundColor Yellow
            }
            
            Write-Host "  Scanned: $CurrentDir" -ForegroundColor Gray
            Write-Host "  Detected Profile: " -NoNewline
            Write-Host "$detectedProfile" -ForegroundColor Green
            Write-Host ""
            
            # Show what standards are available
            $profilePath = Join-Path $RepoRoot "library\profiles\$detectedProfile.json"
            if (Test-Path $profilePath) {
                $profileData = Get-Content $profilePath | ConvertFrom-Json
                Write-Host "  Standards included:" -ForegroundColor Yellow
                foreach ($standard in $profileData.standards.PSObject.Properties.Name) {
                    Write-Host "    ‚úÖ $standard" -ForegroundColor Gray
                }
            }
            
            Write-Host ""
            $confirm = Read-Host "  Link this project to '$detectedProfile'? [Y/n]"
            if ($confirm -eq "n" -or $confirm -eq "N") { return }
            
            # Update projects.json
            $regPath = Join-Path $RepoRoot "config\projects.json"
            if (Test-Path $regPath) {
                $projects = Get-Content $regPath | ConvertFrom-Json
                
                # Find existing or create new
                $existing = $projects | Where-Object { $_.path -eq $CurrentDir }
                
                if ($existing) {
                    $existing | ForEach-Object { $_.profile = $detectedProfile }
                    Write-Host "  ‚úÖ Updated existing project entry" -ForegroundColor Green
                }
                else {
                    $newId = ($projects | Measure-Object -Property id -Maximum).Maximum + 1
                    $newEntry = @{
                        id      = $newId
                        name    = Split-Path $CurrentDir -Leaf
                        path    = $CurrentDir
                        db      = "mesh.db"
                        profile = $detectedProfile
                    }
                    $projects = @($projects) + $newEntry
                    Write-Host "  ‚úÖ Added new project (ID: $newId)" -ForegroundColor Green
                }
                
                $projects | ConvertTo-Json -Depth 4 | Set-Content $regPath
            }
            
            # Store profile in script context
            $script:CurrentProfile = $detectedProfile
            
            # === AUTO-BOOTSTRAP (v7.7) ===
            Write-Host ""
            Write-Host "  üì¶ BOOTSTRAPPING SEED PACKAGE..." -ForegroundColor Cyan
            
            $templatesDir = Join-Path $RepoRoot "library\templates"
            $docsDir = Join-Path $CurrentDir "docs"
            
            # Create docs folder
            if (-not (Test-Path $docsDir)) {
                New-Item -ItemType Directory -Force -Path $docsDir | Out-Null
            }
            
            # Template mapping
            $templates = @{
                "ACTIVE_SPEC.template.md"  = "docs\ACTIVE_SPEC.md"
                "TECH_STACK.template.md"   = "docs\TECH_STACK.md"
                "DECISION_LOG.template.md" = "docs\DECISION_LOG.md"
                "env_template.txt"         = ".env.example"
            }
            
            $created = @()
            $skipped = @()
            $projectName = Split-Path $CurrentDir -Leaf
            $today = Get-Date -Format "yyyy-MM-dd"
            
            foreach ($src in $templates.Keys) {
                $srcPath = Join-Path $templatesDir $src
                $dstPath = Join-Path $CurrentDir $templates[$src]
                
                if (Test-Path $dstPath) {
                    $skipped += $templates[$src]
                    continue
                }
                
                if (Test-Path $srcPath) {
                    # Read template
                    $content = Get-Content $srcPath -Raw -Encoding UTF8
                    
                    # Replace placeholders
                    $content = $content -replace '\{\{PROJECT_NAME\}\}', $projectName
                    $content = $content -replace '\{\{DATE\}\}', $today
                    $content = $content -replace '\{\{AUTHOR\}\}', 'Atomic Mesh'
                    
                    # Ensure parent dir exists
                    $parentDir = Split-Path $dstPath -Parent
                    if (-not (Test-Path $parentDir)) {
                        New-Item -ItemType Directory -Force -Path $parentDir | Out-Null
                    }
                    
                    # Write file
                    Set-Content -Path $dstPath -Value $content -Encoding UTF8
                    $created += $templates[$src]
                }
            }
            
            # Report results
            foreach ($file in $created) {
                Write-Host "    ‚úÖ Created $file" -ForegroundColor Green
            }
            foreach ($file in $skipped) {
                Write-Host "    ‚è≠Ô∏è Skipped $file (exists)" -ForegroundColor Yellow
            }
            
            Write-Host ""
            Write-Host "  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor DarkGray
            Write-Host "  ‚úÖ PROJECT INITIALIZED" -ForegroundColor Green
            Write-Host ""

            # If args provided, continue to /work
            if ($cmdArgs) {
                Write-Host "  ‚Üí Continuing to /work $cmdArgs ..." -ForegroundColor Cyan
                Write-Host ""
                $result = Invoke-SlashCommand -UserInput "/work $cmdArgs"
                if ($result -eq "refresh") { return "refresh" }
            }
            else {
                Write-Host "  What's next?" -ForegroundColor Cyan
                Write-Host "    ‚Ä¢ Type what you're building (e.g., 'JWT auth system')" -ForegroundColor White
                Write-Host "    ‚Ä¢ Or run /ops to check system status" -ForegroundColor Gray
                Write-Host ""
            }
        }
        
        "profile" {
            $regPath = Join-Path $RepoRoot "config\projects.json"
            
            if ($cmdArgs) {
                # Set profile
                if (Test-Path $regPath) {
                    $projects = Get-Content $regPath | ConvertFrom-Json
                    $existing = $projects | Where-Object { $_.path -eq $CurrentDir }
                    if ($existing) {
                        $existing | ForEach-Object { $_.profile = $cmdArgs }
                        $projects | ConvertTo-Json -Depth 4 | Set-Content $regPath
                        Write-Host "  ‚úÖ Profile set to: $cmdArgs" -ForegroundColor Green
                    }
                    else {
                        Write-Host "  ‚ö†Ô∏è Project not in registry. Run /init first." -ForegroundColor Yellow
                    }
                }
            }
            else {
                # Show current profile
                $profile = "unknown"
                if (Test-Path $regPath) {
                    $projects = Get-Content $regPath | ConvertFrom-Json
                    $existing = $projects | Where-Object { $_.path -eq $CurrentDir }
                    if ($existing) { $profile = $existing.profile }
                }
                Write-Host ""
                Write-Host "  Current Profile: $profile" -ForegroundColor Cyan
                Write-Host "  Project Path: $CurrentDir" -ForegroundColor Gray
                Write-Host ""
                Write-Host "  Available profiles:" -ForegroundColor Yellow
                $profilesPath = Join-Path $RepoRoot "library\profiles"
                if (Test-Path $profilesPath) {
                    Get-ChildItem $profilesPath -Filter "*.json" | ForEach-Object {
                        $name = $_.BaseName
                        $indicator = if ($name -eq $profile) { " ‚Üê" } else { "" }
                        Write-Host "    - $name$indicator" -ForegroundColor Gray
                    }
                }
            }
        }
        
        "standard" {
            if (-not $cmdArgs) {
                Write-Host "  Usage: /standard <topic>" -ForegroundColor Yellow
                Write-Host "  Topics: security, architecture, folder_structure, testing, git, code_review" -ForegroundColor Gray
                return
            }
            
            # Get current profile
            $profile = "general"
            $regPath = Join-Path $RepoRoot "config\projects.json"
            if (Test-Path $regPath) {
                $projects = Get-Content $regPath | ConvertFrom-Json
                $existing = $projects | Where-Object { $_.path -eq $CurrentDir }
                if ($existing -and $existing.profile) { $profile = $existing.profile }
            }
            
            # Fetch standard via Python
            try {
                $pyScript = @"
import sys
sys.path.insert(0, r'$RepoRoot\src')
from mesh_server import consult_standard
print(consult_standard('$cmdArgs', '$profile'))
"@
                $result = $pyScript | python 2>$null
                Write-Host ""
                Write-Host $result
            }
            catch {
                Write-Host "  ‚ö†Ô∏è Failed to fetch standard" -ForegroundColor Yellow
            }
        }
        
        "standards" {
            # Get current profile
            $profile = "general"
            $regPath = Join-Path $RepoRoot "config\projects.json"
            if (Test-Path $regPath) {
                $projects = Get-Content $regPath | ConvertFrom-Json
                $existing = $projects | Where-Object { $_.path -eq $CurrentDir }
                if ($existing -and $existing.profile) { $profile = $existing.profile }
            }
            
            Write-Host ""
            Write-Host "  ‚ïê‚ïê‚ïê AVAILABLE STANDARDS ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
            Write-Host "  Profile: $profile" -ForegroundColor Gray
            Write-Host ""
            
            $profilePath = Join-Path $RepoRoot "library\profiles\$profile.json"
            if (Test-Path $profilePath) {
                $profileData = Get-Content $profilePath | ConvertFrom-Json
                
                Write-Host "  Standards:" -ForegroundColor Yellow
                foreach ($standard in $profileData.standards.PSObject.Properties.Name) {
                    Write-Host "    ‚Ä¢ $standard" -ForegroundColor White
                }
                
                Write-Host ""
                Write-Host "  References:" -ForegroundColor Yellow
                foreach ($ref in $profileData.references.PSObject.Properties.Name) {
                    Write-Host "    ‚Ä¢ $ref" -ForegroundColor White
                }
                
                Write-Host ""
                Write-Host "  Use: /standard <topic>" -ForegroundColor Gray
            }
            else {
                Write-Host "  ‚ö†Ô∏è Profile '$projectProfile' not found" -ForegroundColor Yellow
            }
        }
        
        # === v8.0 PRE-FLIGHT PROTOCOL ===
        "ship" {
            Write-Host ""
            Write-Host "  üöÄ SHIPPING TO PRODUCTION (v8.0)" -ForegroundColor Cyan
            Write-Host ""
            
            $message = if ($cmdArgs) { $cmdArgs } else { "release: $(Get-Date -Format 'yyyy-MM-dd HH:mm')" }
            
            # Check for uncommitted changes
            $gitStatus = git status --porcelain 2>&1
            
            if ([string]::IsNullOrWhiteSpace($gitStatus)) {
                Write-Host "  ‚è≠Ô∏è Nothing to commit (working tree clean)" -ForegroundColor Yellow
                return
            }
            
            Write-Host "  üìã Pre-flight: Local QA has verified this code" -ForegroundColor Gray
            Write-Host "  üì¶ Changes to ship:" -ForegroundColor Gray
            
            # Show changed files
            $changes = git status --porcelain
            $changes | ForEach-Object { 
                $status = $_.Substring(0, 2).Trim()
                $file = $_.Substring(3)
                $icon = switch ($status) {
                    "M" { "üìù" }
                    "A" { "‚ûï" }
                    "D" { "‚ûñ" }
                    default { "‚Ä¢" }
                }
                Write-Host "      $icon $file" -ForegroundColor DarkGray
            }
            
            Write-Host ""
            $confirm = Read-Host "  Ship with message '$message'? [Y/n]"
            
            if ($confirm -eq "n" -or $confirm -eq "N") {
                Write-Host "  ‚èπÔ∏è Shipping cancelled" -ForegroundColor Yellow
                return
            }
            
            # Git operations
            Write-Host ""
            Write-Host "  üì¶ Staging changes..." -ForegroundColor Gray
            git add .
            
            Write-Host "  üíæ Committing..." -ForegroundColor Gray
            git commit -m "release: $message"
            
            if ($LASTEXITCODE -eq 0) {
                Write-Host "  üöÄ Pushing to remote..." -ForegroundColor Gray
                git push
                
                if ($LASTEXITCODE -eq 0) {
                    Write-Host ""
                    Write-Host "  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor DarkGray
                    Write-Host "  ‚úÖ SHIPPED SUCCESSFULLY" -ForegroundColor Green
                    Write-Host ""
                    Write-Host "  üëÄ Watch the GitHub Actions tab for deployment" -ForegroundColor Cyan
                    Write-Host ""
                }
                else {
                    Write-Host "  ‚ö†Ô∏è Push failed - check remote/auth" -ForegroundColor Yellow
                }
            }
            else {
                Write-Host "  ‚ö†Ô∏è Commit failed" -ForegroundColor Yellow
            }
        }
        
        "preflight" {
            Write-Host ""
            Write-Host "  üß™ PRE-FLIGHT CHECK (v8.0)" -ForegroundColor Cyan
            Write-Host ""
            
            # Detect project type
            $projectType = "unknown"
            if (Test-Path "next.config.js") { $projectType = "typescript_next" }
            elseif (Test-Path "next.config.mjs") { $projectType = "typescript_next" }
            elseif (Test-Path "package.json") { $projectType = "typescript_node" }
            elseif (Test-Path "requirements.txt") { $projectType = "python_backend" }
            elseif (Test-Path "pyproject.toml") { $projectType = "python_backend" }
            
            Write-Host "  Project Type: $projectType" -ForegroundColor Gray
            Write-Host ""
            
            # Run tests based on project type
            $testCmd = $null
            switch ($projectType) {
                "python_backend" {
                    if ((Test-Path "tests") -or (Test-Path "pytest.ini")) {
                        $testCmd = "pytest -x -q --tb=short"
                    }
                }
                "typescript_next" {
                    if (Test-Path "package.json") {
                        $testCmd = "npm test -- --passWithNoTests --watchAll=false"
                    }
                }
                "typescript_node" {
                    if (Test-Path "package.json") {
                        $testCmd = "npm test -- --passWithNoTests --watchAll=false"
                    }
                }
            }
            
            if (-not $testCmd) {
                Write-Host "  ‚è≠Ô∏è No test suite detected (skipping)" -ForegroundColor Yellow
                return
            }
            
            Write-Host "  Running: $testCmd" -ForegroundColor Gray
            Write-Host ""
            
            # Execute tests
            try {
                $result = Invoke-Expression $testCmd 2>&1
                
                if ($LASTEXITCODE -eq 0) {
                    Write-Host ""
                    Write-Host "  ‚úÖ PRE-FLIGHT PASSED" -ForegroundColor Green
                    Write-Host "  Code is ready for Dual QA" -ForegroundColor Gray
                }
                else {
                    Write-Host ""
                    Write-Host "  ‚ùå PRE-FLIGHT FAILED" -ForegroundColor Red
                    Write-Host "  Fix tests before proceeding to QA" -ForegroundColor Yellow
                }
            }
            catch {
                Write-Host "  ‚ö†Ô∏è Test execution error: $_" -ForegroundColor Yellow
            }
        }
        
        # === v8.2 DIAGNOSTICS (Gap #3 Fix) ===
        "doctor" {
            Write-Host ""
            Write-Host "  üè• ATOMIC MESH DOCTOR (v8.2)" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            Write-Host ""
            
            $allGreen = $true
            
            # 1. Check Database
            Write-Host "  Database:" -NoNewline
            if (Test-Path $env:ATOMIC_MESH_DB) {
                Write-Host " üü¢ OK" -ForegroundColor Green -NoNewline
                Write-Host " ($env:ATOMIC_MESH_DB)" -ForegroundColor Gray
            }
            else {
                Write-Host " üî¥ NOT FOUND" -ForegroundColor Red
                $allGreen = $false
            }
            
            # 2. Check Python
            Write-Host "  Python:" -NoNewline
            try {
                $pyVer = & python --version 2>&1
                if ($LASTEXITCODE -eq 0) {
                    Write-Host " üü¢ OK" -ForegroundColor Green -NoNewline
                    Write-Host " ($pyVer)" -ForegroundColor Gray
                }
                else {
                    Write-Host " üî¥ ERROR" -ForegroundColor Red
                    $allGreen = $false
                }
            }
            catch {
                Write-Host " üî¥ NOT FOUND" -ForegroundColor Red
                $allGreen = $false
            }
            
            # 3. Check WAL Mode
            Write-Host "  DB Mode:" -NoNewline
            try {
                $walCheck = & python -c "import sqlite3; print(sqlite3.connect('$env:ATOMIC_MESH_DB').execute('PRAGMA journal_mode').fetchone()[0])" 2>&1
                if ($walCheck -eq "wal") {
                    Write-Host " üü¢ WAL Enabled" -ForegroundColor Green
                }
                else {
                    Write-Host " üü° $walCheck" -ForegroundColor Yellow -NoNewline
                    Write-Host " (should be WAL)" -ForegroundColor Gray
                }
            }
            catch {
                Write-Host " ‚ö†Ô∏è Could not check" -ForegroundColor Yellow
            }
            
            # 4. Check MCP Module
            Write-Host "  MCP Library:" -NoNewline
            try {
                $mcpCheck = & python -c "import mcp; print('ok')" 2>&1
                if ($mcpCheck -eq "ok") {
                    Write-Host " üü¢ OK" -ForegroundColor Green
                }
                else {
                    Write-Host " üî¥ MISSING" -ForegroundColor Red -NoNewline
                    Write-Host " (pip install mcp)" -ForegroundColor Gray
                    $allGreen = $false
                }
            }
            catch {
                Write-Host " üî¥ MISSING" -ForegroundColor Red
                $allGreen = $false
            }
            
            # 5. Check Git Status
            Write-Host "  Git:" -NoNewline
            try {
                $gitStatus = git status --porcelain 2>&1
                if ([string]::IsNullOrWhiteSpace($gitStatus)) {
                    Write-Host " üü¢ Clean" -ForegroundColor Green
                }
                else {
                    $changeCount = ($gitStatus -split "`n").Count
                    Write-Host " üü° $changeCount uncommitted changes" -ForegroundColor Yellow
                }
            }
            catch {
                Write-Host " ‚ö†Ô∏è Not a git repo" -ForegroundColor Yellow
            }
            
            # 6. Check Core Modules
            Write-Host "  Modules:" -NoNewline
            $modules = @("qa_protocol", "product_owner", "guardrails")
            $modOk = $true
            foreach ($mod in $modules) {
                $modCheck = & python -c "import $mod; print('ok')" 2>&1
                if ($modCheck -ne "ok") { $modOk = $false }
            }
            if ($modOk) {
                Write-Host " üü¢ All loaded" -ForegroundColor Green
            }
            else {
                Write-Host " üü° Some missing" -ForegroundColor Yellow
            }
            
            Write-Host ""
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            if ($allGreen) {
                Write-Host "  STATUS: üü¢ HEALTHY" -ForegroundColor Green
            }
            else {
                Write-Host "  STATUS: üî¥ ISSUES DETECTED" -ForegroundColor Red
            }
            Write-Host ""
        }
        
        # === v8.4.1 SPEC LINTER ===
        "refine" {
            Write-Host ""
            Write-Host "  üßê SPEC LINTER (v8.4.1)" -ForegroundColor Cyan
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            Write-Host ""
            
            $specPath = Join-Path (Get-Location) "docs\ACTIVE_SPEC.md"
            
            if (-not (Test-Path $specPath)) {
                Write-Host "  ‚ùå No ACTIVE_SPEC.md found." -ForegroundColor Red
                Write-Host "     Run /init first to create spec template." -ForegroundColor Gray
                return
            }
            
            Write-Host "  Analyzing: docs/ACTIVE_SPEC.md" -ForegroundColor Gray
            Write-Host ""
            
            # Run Python spec linter
            try {
                $result = & python -c "from spec_linter import run_spec_linter_sync; print(run_spec_linter_sync())" 2>&1
                
                if ($LASTEXITCODE -eq 0) {
                    Write-Host $result -ForegroundColor Yellow
                }
                else {
                    # Fallback: Simple local analysis
                    $specContent = Get-Content $specPath -Raw
                    $issues = @()
                    
                    $patterns = @(
                        @{Pattern = "should"; Reason = "Vague - does this mean 'must'?" }
                        @{Pattern = "etc"; Reason = "Incomplete list - what else?" }
                        @{Pattern = "appropriate"; Reason = "Subjective - define criteria" }
                        @{Pattern = "somehow"; Reason = "Implementation unclear" }
                        @{Pattern = "various"; Reason = "Which ones specifically?" }
                    )
                    
                    foreach ($p in $patterns) {
                        if ($specContent -match $p.Pattern) {
                            $issues += "  ‚ö†Ô∏è Found '$($p.Pattern)': $($p.Reason)"
                        }
                    }
                    
                    if ($issues.Count -gt 0) {
                        Write-Host "  Found $($issues.Count) potential ambiguities:" -ForegroundColor Yellow
                        Write-Host ""
                        foreach ($issue in $issues) {
                            Write-Host $issue -ForegroundColor DarkYellow
                        }
                    }
                    else {
                        Write-Host "  ‚úÖ No obvious ambiguities detected." -ForegroundColor Green
                    }
                }
            }
            catch {
                Write-Host "  ‚ö†Ô∏è Linter error: $_" -ForegroundColor Yellow
            }
            
            Write-Host ""
            Write-Host "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" -ForegroundColor DarkGray
            Write-Host "  TIP: Update docs/ACTIVE_SPEC.md to resolve queries." -ForegroundColor Gray
            Write-Host ""
        }
        
        # === VIEWS ===
        "status" { return "refresh" }
        "plan" { Show-Plan }
        "tasks" { Show-Tasks }

        # v13.1 VIEW COMMANDS
        "dash" {
            $Global:ViewOverride = "dash"
            Write-Host "  üìä View override: dashboard" -ForegroundColor Cyan
            return "refresh"
        }
        "compact" {
            $Global:ViewOverride = "compact"
            Write-Host "  üìã View override: compact" -ForegroundColor Cyan
            return "refresh"
        }

        # === v13.2 OPS COMMANDS ===
        "ops" {
            Write-Host ""
            Write-Host "  ‚ïê‚ïê‚ïê OPS OVERVIEW (v13.2) ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
            Write-Host ""

            # Health Check
            Write-Host "  HEALTH:" -ForegroundColor Yellow
            try {
                $health = python -c "from mesh_server import get_health_report; print(get_health_report())" 2>&1
                $healthLines = $health -split "`n"
                foreach ($line in $healthLines | Select-Object -First 5) {
                    Write-Host "    $line" -ForegroundColor Gray
                }
            }
            catch {
                Write-Host "    ‚ö†Ô∏è Health check unavailable" -ForegroundColor Yellow
            }

            Write-Host ""

            # Drift Check
            Write-Host "  DRIFT:" -ForegroundColor Yellow
            try {
                $drift = python -c "from mesh_server import get_drift_report; print(get_drift_report())" 2>&1
                $driftLines = $drift -split "`n"
                foreach ($line in $driftLines | Select-Object -First 5) {
                    Write-Host "    $line" -ForegroundColor Gray
                }
            }
            catch {
                Write-Host "    ‚ö†Ô∏è Drift check unavailable" -ForegroundColor Yellow
            }

            Write-Host ""

            # Backup Status
            Write-Host "  BACKUPS:" -ForegroundColor Yellow
            $snapshotDir = Join-Path (Get-Location) "control\snapshots"
            if (Test-Path $snapshotDir) {
                $snapshots = Get-ChildItem $snapshotDir -Filter "*.zip" | Sort-Object LastWriteTime -Descending | Select-Object -First 3
                if ($snapshots) {
                    foreach ($s in $snapshots) {
                        $age = [math]::Round(((Get-Date) - $s.LastWriteTime).TotalHours, 1)
                        Write-Host "    üì¶ $($s.Name) (${age}h ago)" -ForegroundColor Gray
                    }
                }
                else {
                    Write-Host "    ‚ö†Ô∏è No backups found" -ForegroundColor Yellow
                }
            }
            else {
                Write-Host "    ‚ö†Ô∏è Snapshot directory not found" -ForegroundColor Yellow
            }

            Write-Host ""
        }

        "health" {
            Write-Host ""
            Write-Host "  ‚ïê‚ïê‚ïê HEALTH CHECK (v13.2) ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
            Write-Host ""
            try {
                $health = python -c "from mesh_server import get_health_report; print(get_health_report())" 2>&1
                Write-Host $health -ForegroundColor Gray
            }
            catch {
                Write-Host "  ‚ö†Ô∏è Health check unavailable: $_" -ForegroundColor Yellow
            }
            Write-Host ""
        }

        "drift" {
            Write-Host ""
            Write-Host "  ‚ïê‚ïê‚ïê DRIFT CHECK (v13.2) ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
            Write-Host ""
            try {
                $drift = python -c "from mesh_server import get_drift_report; print(get_drift_report())" 2>&1
                Write-Host $drift -ForegroundColor Gray
            }
            catch {
                Write-Host "  ‚ö†Ô∏è Drift check unavailable: $_" -ForegroundColor Yellow
            }
            Write-Host ""
        }

        "work" {
            Write-Host ""
            Write-Host "  ‚ïê‚ïê‚ïê KNOWLEDGE ACQUISITION (v13.2) ‚ïê‚ïê‚ïê" -ForegroundColor Cyan
            Write-Host ""
            if ($cmdArgs) {
                Write-Host "  üì• Starting work with prefix: $cmdArgs" -ForegroundColor Yellow
                Write-Host "     (Knowledge ingestion from docs/inbox/)" -ForegroundColor Gray
                # Call existing ingest or knowledge tools
                try {
                    $result = python -c "import asyncio; from product_owner import ingest_inbox; print(asyncio.run(ingest_inbox()))" 2>&1
                    Write-Host "  $result" -ForegroundColor Green
                }
                catch {
                    Write-Host "  ‚ö†Ô∏è Work command error: $_" -ForegroundColor Yellow
                }
            }
            else {
                Write-Host "  Usage: /work <PREFIX>" -ForegroundColor Yellow
                Write-Host "  Example: /work HIPAA" -ForegroundColor Gray
                Write-Host "  This stages knowledge for the current planning context." -ForegroundColor Gray
            }
            Write-Host ""
        }

        # === UNKNOWN ===
        default {
            Write-Host "  ‚ùì Unknown command: /$cmd" -ForegroundColor Red
            Write-Host "  Type /help to see available commands" -ForegroundColor Gray
        }
    }
    
    return $null
}

# ============================================================================
# v13.2: MODAL ROUTING - Pure frontend, no backend calls
# ============================================================================

function Invoke-ModalRoute {
    param([string]$Text)

    # v13.2: Route plain text by current mode using keyword matching
    # No backend calls - pure CLI-side routing

    Write-Host ""

    switch ($Global:CurrentMode) {
        "OPS" {
            # OPS mode: health/drift monitoring keywords
            if ($Text -match "(?i)^health") {
                Write-Host "  ‚ñ∂ /health" -ForegroundColor Cyan
                $result = Invoke-SlashCommand -UserInput "/health"
                if ($result -eq "refresh") { Initialize-Screen }
            }
            elseif ($Text -match "(?i)(drift|backup|snapshot|stale)") {
                Write-Host "  ‚ñ∂ /drift" -ForegroundColor Cyan
                $result = Invoke-SlashCommand -UserInput "/drift"
                if ($result -eq "refresh") { Initialize-Screen }
            }
            elseif ($Text -match "(?i)^status") {
                Write-Host "  ‚ñ∂ /status" -ForegroundColor Cyan
                $result = Invoke-SlashCommand -UserInput "/status"
                if ($result -eq "refresh") { Initialize-Screen }
            }
            else {
                # Hint for OPS mode
                Write-Host "  üí° OPS Mode Hints:" -ForegroundColor Cyan
                Write-Host "     'health' ‚Üí /health    | 'drift' ‚Üí /drift" -ForegroundColor Gray
                Write-Host "     'status' ‚Üí /status    | Tab ‚Üí switch mode" -ForegroundColor Gray
            }
        }

        "PLAN" {
            # PLAN mode: Stage context and show plan
            $Global:LastPlanNote = $Text
            Write-Host "  üìù Plan context staged: $Text" -ForegroundColor Yellow
            Write-Host ""
            $result = Invoke-SlashCommand -UserInput "/plan"
            if ($result -eq "refresh") { Initialize-Screen }
        }

        "RUN" {
            # RUN mode: Stage steering note and execute
            $Global:LastRunNote = $Text
            Write-Host "  ‚öôÔ∏è Steering note staged: $Text" -ForegroundColor Magenta
            Write-Host ""
            $result = Invoke-SlashCommand -UserInput "/run"
            if ($result -eq "refresh") { Initialize-Screen }
        }

        "SHIP" {
            # SHIP mode: Stage release note but DO NOT auto-run /ship
            $Global:LastShipNote = $Text
            Write-Host "  üßæ Release note staged: $Text" -ForegroundColor Green
            Write-Host ""
            Write-Host "  ‚ö†Ô∏è  SHIP requires explicit command:" -ForegroundColor Yellow
            Write-Host "     Type '/ship' to run preflight" -ForegroundColor Gray
            Write-Host "     Type '/ship --confirm' to release" -ForegroundColor Gray
        }
    }
}

function Invoke-DefaultAction {
    # v13.2: Run default action for current mode when Enter pressed with empty input

    switch ($Global:CurrentMode) {
        "OPS" {
            # Default: show status/health
            Write-Host ""
            Write-Host "  ‚ñ∂ /ops" -ForegroundColor Cyan
            $result = Invoke-SlashCommand -UserInput "/ops"
            if ($result -eq "refresh") { Initialize-Screen }
        }

        "PLAN" {
            # Default: show plan
            Write-Host ""
            Write-Host "  ‚ñ∂ /plan" -ForegroundColor Yellow
            $result = Invoke-SlashCommand -UserInput "/plan"
            if ($result -eq "refresh") { Initialize-Screen }
        }

        "RUN" {
            # Default: show run status (tasks)
            Write-Host ""
            Write-Host "  ‚ñ∂ /run" -ForegroundColor Magenta
            $result = Invoke-SlashCommand -UserInput "/run"
            if ($result -eq "refresh") { Initialize-Screen }
        }

        "SHIP" {
            # Default: show preflight (read-only, safe)
            Write-Host ""
            Write-Host "  ‚ñ∂ /ship (preflight preview)" -ForegroundColor Green
            $result = Invoke-SlashCommand -UserInput "/ship"
            if ($result -eq "refresh") { Initialize-Screen }
        }
    }
}

function Switch-Mode {
    param([string]$NewMode)

    # v13.2: Switch to specified mode
    $validModes = @("OPS", "PLAN", "RUN", "SHIP")
    $modeUpper = $NewMode.ToUpper()

    if ($validModes -contains $modeUpper) {
        $Global:CurrentMode = $modeUpper
        $config = $Global:ModeConfig[$modeUpper]
        Write-Host ""
        Write-Host "  ‚Üí Switched to $($config.Prompt)" -ForegroundColor $config.Color
        Write-Host "     $($config.Hint)" -ForegroundColor DarkGray
    }
    else {
        Write-Host ""
        Write-Host "  ‚ùì Unknown mode: $NewMode" -ForegroundColor Yellow
        Write-Host "     Valid modes: OPS, PLAN, RUN, SHIP" -ForegroundColor Gray
    }
}

# ============================================================================
# INDUSTRIAL-GRADE TUI ENGINE (Coordinate-Based)
# ============================================================================
# Every element is painted at specific X,Y coordinates - no streaming output

# --- GLOBAL ROW CONSTANTS ---
$Global:RowHeader = 0
$Global:RowDashStart = 4
$Global:MaxDropdownRows = 5  # Keep small to avoid terminal resize

# Calculate input row at 75% height (bottom 1/4 reserved for input area)
$termHeight = $Host.UI.RawUI.WindowSize.Height
$Global:RowInput = [Math]::Floor($termHeight * 0.75)
$Global:RowDropdown = $Global:RowInput + 1

# v13.3.6: Shared left offset for input area alignment
# Aligns input bar with "  Next:" label (2-space indent)
$Global:InputLeft = 2

# --- CORE POSITIONING FUNCTION ---
function Set-Pos {
    param([int]$Row, [int]$Col = 0)
    try {
        $pos = $Host.UI.RawUI.CursorPosition
        $pos.X = $Col
        $pos.Y = $Row
        $Host.UI.RawUI.CursorPosition = $pos
    }
    catch {}
}

# --- v13.3.5: Get fresh layout values (single source of truth) ---
function Get-PromptLayout {
    $w = $Host.UI.RawUI.WindowSize.Width
    $h = $Host.UI.RawUI.WindowSize.Height
    # Input row at 75% height, but cap to avoid writing past terminal
    $inputRow = [Math]::Min($Global:RowInput, $h - 5)
    # v13.3.5: Editor-style footer layout (Next: left, [MODE] right, above input):
    #   RowInput - 2: Footer bar (Next: left, [MODE] right)
    #   RowInput - 1: Top border ‚îå‚îÄ‚îÄ‚îÄ‚îê
    #   RowInput:     Input line ‚îÇ > ‚îÇ
    #   RowInput + 1: Bottom border ‚îî‚îÄ‚îÄ‚îÄ‚îò
    #   RowInput + 2: Dropdown starts here (when picker is open)
    return @{
        RowInput    = $inputRow
        DropdownRow = $inputRow + 2  # Below bottom border
        Width       = $w
        MaxVisible  = [Math]::Min(8, $h - $inputRow - 3)  # Don't exceed terminal
        TermHeight  = $h
    }
}

# --- v13.3.5: Clear prompt region atomically ---
function Clear-PromptRegion {
    param([int]$ExtraRows = 0)
    $layout = Get-PromptLayout
    $clearWidth = $layout.Width
    # v13.3.5: Clear from footer (RowInput-2) through bottom border (RowInput+1) + dropdown
    # Layout: footer(-2), top border(-1), input(0), bottom border(+1), dropdown(+2...)
    $startRow = $layout.RowInput - 2
    $totalRows = $layout.MaxVisible + 4 + $ExtraRows  # +4 for footer, borders, dropdown buffer
    for ($i = 0; $i -lt $totalRows; $i++) {
        $row = $startRow + $i
        if ($row -ge 0 -and $row -lt $layout.TermHeight) {
            Set-Pos $row 0
            Write-Host (" " * $clearWidth) -NoNewline
        }
    }
    Set-Pos $layout.RowInput 0
}

# --- v13.3.5: Redraw prompt and footer ---
function Redraw-PromptRegion {
    # v13.3.5: Redraw footer (above) + framed input bar
    $layout = Get-PromptLayout
    $width = $layout.Width
    # Clear region first
    Clear-PromptRegion
    # Draw footer (Next: left, [MODE] right) - above input
    Draw-FooterBar
    # Draw framed input bar
    Draw-InputBar -width $width -rowInput $layout.RowInput
    # Position cursor inside frame (after "‚îÇ > ")
    Set-Pos $layout.RowInput ($Global:InputLeft + 4)
}

# --- v9.3 STATUS FETCHER ---
function Get-WorkerStatus {
    $status = @{
        backend_status   = "IDLE"
        backend_task     = "(none)"
        backend_streams  = 0
        frontend_status  = "IDLE"
        frontend_task    = "(none)"
        qa_sessions      = 0
        lib_status_text  = "CLEAN"
        lib_status_color = "Green"
        po_status_color  = "Green"
        po_next_decision = "No pending inputs"
        worker_cot       = "Idling..."
    }
    
    # Get active tasks
    $activeTasks = Invoke-Query "SELECT type, id, substr(desc,1,25) as d FROM tasks WHERE status='in_progress' LIMIT 2" -Silent
    foreach ($t in $activeTasks) {
        if ($t.type -eq "backend") {
            $status.backend_status = "UP"
            $status.backend_task = "[$($t.id)] $($t.d)"
        }
        elseif ($t.type -eq "frontend") {
            $status.frontend_status = "UP"
            $status.frontend_task = "[$($t.id)] $($t.d)"
        }
    }
    
    # Count active streams
    $streams = Invoke-Query "SELECT COUNT(*) as c FROM tasks WHERE status='in_progress'" -Silent
    if ($streams.Count -gt 0) { $status.backend_streams = $streams[0].c }
    
    # QA pending sessions
    $qaPending = Invoke-Query "SELECT COUNT(*) as c FROM tasks WHERE auditor_status='pending' AND status='completed'" -Silent
    if ($qaPending.Count -gt 0) { $status.qa_sessions = $qaPending[0].c }
    
    # Blocked tasks (PO status)
    $blocked = Invoke-Query "SELECT COUNT(*) as c FROM tasks WHERE status='blocked'" -Silent
    if ($blocked.Count -gt 0 -and $blocked[0].c -gt 0) {
        $status.po_status_color = "Red"
        $status.po_next_decision = "$($blocked[0].c) blocked tasks"
    }
    
    # Pending decisions
    $decisions = Invoke-Query "SELECT COUNT(*) as c FROM decisions WHERE status='pending'" -Silent
    if ($decisions.Count -gt 0 -and $decisions[0].c -gt 0 -and $status.po_status_color -ne "Red") {
        $status.po_status_color = "Yellow"
        $status.po_next_decision = "$($decisions[0].c) decisions pending"
    }
    
    # Librarian status (check loose files)
    $root = Get-Location
    $looseFiles = @(Get-ChildItem -Path $root -File -ErrorAction SilentlyContinue | 
        Where-Object { $_.Name -notin @("README.md", ".gitignore", "requirements.txt", "LICENSE", "mesh.db", ".mesh_mode", ".milestone_date") })
    if ($looseFiles.Count -gt 5) {
        $status.lib_status_text = "MESSY"
        $status.lib_status_color = "Red"
    }
    elseif ($looseFiles.Count -gt 3) {
        $status.lib_status_text = "CLUTTERED"
        $status.lib_status_color = "Yellow"
    }
    
    # Worker COT (last log line)
    $LogPath = Join-Path $root "logs\mesh.log"
    if (Test-Path $LogPath) {
        $lastLine = Get-Content $LogPath -Tail 1 -ErrorAction SilentlyContinue
        if ($lastLine) {
            $cot = if ($lastLine -match "\|") { ($lastLine -split "\|")[-1].Trim() } else { $lastLine.Trim() }
            if ($cot.Length -gt 35) { $cot = $cot.Substring(0, 32) + "..." }
            $status.worker_cot = $cot
        }
    }
    
    return $status
}

# --- PRINT ROW WITH ABSOLUTE POSITIONING ---
function Print-Row {
    param(
        [int]$Row,
        [string]$LeftTxt,
        [string]$RightTxt,
        [int]$HalfWidth,
        [string]$ColorL = "White",
        [string]$ColorR = "White"
    )
    
    $ContentWidth = $HalfWidth - 4
    
    # Truncate if needed
    if ($LeftTxt.Length -gt $ContentWidth) { $LeftTxt = $LeftTxt.Substring(0, $ContentWidth - 3) + "..." }
    if ($RightTxt.Length -gt $ContentWidth) { $RightTxt = $RightTxt.Substring(0, $ContentWidth - 3) + "..." }
    
    # Draw Left Box at column 0
    Set-Pos $Row 0
    Write-Host "| " -NoNewline -ForegroundColor DarkGray
    Write-Host $LeftTxt.PadRight($ContentWidth) -NoNewline -ForegroundColor $ColorL
    Write-Host " |" -NoNewline -ForegroundColor DarkGray
    
    # Draw Right Box at column HalfWidth
    Set-Pos $Row $HalfWidth
    Write-Host "| " -NoNewline -ForegroundColor DarkGray
    Write-Host $RightTxt.PadRight($ContentWidth) -NoNewline -ForegroundColor $ColorR
    Write-Host " |" -NoNewline -ForegroundColor DarkGray
}

# --- DRAW BORDER LINE ---
function Draw-Border {
    param([int]$Row, [int]$HalfWidth)
    
    $line = "-" * ($HalfWidth - 2)
    Set-Pos $Row 0
    Write-Host "+$line+" -NoNewline -ForegroundColor DarkGray
    Set-Pos $Row $HalfWidth
    Write-Host "+$line+" -NoNewline -ForegroundColor DarkGray
}

# --- v9.3 DASHBOARD: EXECUTION RESOURCES vs COGNITIVE STATE (with Actionable Hints) ---
function Draw-Dashboard {
    # 1. Fetch Data
    $Data = Get-WorkerStatus
    
    # Get decisions
    $DecisionLog = Join-Path (Get-Location) "docs\DECISION_LOG.md"
    $Decisions = @()
    if (Test-Path $DecisionLog) {
        $Decisions = Get-Content $DecisionLog -ErrorAction SilentlyContinue | 
        Where-Object { $_ -match "^\|.*\|" -and $_ -notmatch "^[\|\-\s]+$" -and $_ -notmatch "ID\s*\|" } | 
        Select-Object -Last 2
    }
    
    # Get audit logs
    $LogFile = Join-Path (Get-Location) "logs\mesh.log"
    $AuditLog = @()
    if (Test-Path $LogFile) {
        $AuditLog = Get-Content $LogFile -ErrorAction SilentlyContinue | Select-Object -Last 2
    }
    
    # 2. Dimensions
    $W = $Host.UI.RawUI.WindowSize.Width
    $Half = [Math]::Floor($W / 2)
    $R = $Global:RowDashStart
    
    # v9.6: Get Mode and Days to Milestone for header
    $Mode = "vibe"
    $MileDays = ""
    try {
        $modeResult = Invoke-Query "SELECT value FROM config WHERE key='mode'" -Silent
        if ($modeResult) { $Mode = $modeResult[0].value }
    }
    catch {}
    
    # Check milestone file
    $MileFile = Join-Path (Get-Location) ".milestone"
    if (Test-Path $MileFile) {
        try {
            $MileDate = Get-Content $MileFile -Raw
            $Days = ([datetime]$MileDate - (Get-Date)).Days
            if ($Days -ge 0) { $MileDays = " | DAYS: $Days" }
        }
        catch {}
    }
    
    $ModeIcon = switch ($Mode) { "vibe" { "üèñÔ∏è" } "converge" { "üî®" } "ship" { "üöÄ" } default { "" } }
    $ModeColor = switch ($Mode) { "vibe" { "Green" } "converge" { "Yellow" } "ship" { "Red" } default { "White" } }
    
    # v9.7: Get Core Lock status
    $LockIcon = "üîí"
    try {
        $lockResult = python -c "from dynamic_rigor import get_lock_status; print(get_lock_status()['icon'])" 2>&1
        if ($lockResult -eq "üîì") { $LockIcon = "üîì" }
    }
    catch {}
    
    # v9.8: Get Task State from state machine
    $TaskStatus = ""
    $TaskColor = "White"
    try {
        $stateResult = python -c "from dynamic_rigor import get_task_status_display; import json; s = get_task_status_display(); print(json.dumps(s))" 2>&1
        $taskState = $stateResult | ConvertFrom-Json -ErrorAction SilentlyContinue
        if ($taskState) {
            $TaskStatus = " | $($taskState.icon) $($taskState.status)"
            $TaskColor = switch ($taskState.status) {
                "WAITING" { "Yellow" }
                "READY" { "Green" }
                "IN_PROGRESS" { "Cyan" }
                "IDLE" { "DarkGray" }
                default { "White" }
            }
        }
    }
    catch {}
    
    # --- BORDERS & HEADERS ---
    Set-Pos $R 0; Write-Host ("+" + ("-" * ($Half - 2)) + "+") -NoNewline -ForegroundColor DarkGray
    Set-Pos $R $Half; Write-Host ("+" + ("-" * ($Half - 2)) + "+") -NoNewline -ForegroundColor DarkGray
    $R++
    
    # v9.6/v9.7/v9.8: Show Phase, Core Lock, and Task Status
    $LeftHeader = "EXEC [$($Mode.ToUpper()) $ModeIcon] [CORE: $LockIcon]"
    $RightHeader = "COGNITIVE$TaskStatus$MileDays"
    Print-Row $R $LeftHeader $RightHeader $Half $ModeColor $TaskColor
    $R++
    
    Set-Pos $R 0; Write-Host ("+" + ("-" * ($Half - 2)) + "+") -NoNewline -ForegroundColor DarkGray
    Set-Pos $R $Half; Write-Host ("+" + ("-" * ($Half - 2)) + "+") -NoNewline -ForegroundColor DarkGray
    $R++

    # --- ROW: BACKEND & PO ---
    $BE_Color = if ($Data.backend_status -eq "UP") { "Green" } elseif ($Data.backend_status -eq "IDLE") { "Yellow" } else { "Red" }
    $BE_Txt = "BACKEND  [$($Data.backend_status)]"
    if ($Data.backend_streams -and $Data.backend_streams -gt 0) { $BE_Txt += " | Str: #$($Data.backend_streams)" }
    
    $PO_Txt = "PRODUCT OWNER  [$($Data.po_next_decision)]"
    
    # HINT LOGIC: PO
    if ($Data.po_status_color -ne "Green") {
        Print-Row-With-Hint $R $BE_Txt $PO_Txt $Half $BE_Color $Data.po_status_color "-> /decide"
    }
    else {
        Print-Row $R $BE_Txt $PO_Txt $Half $BE_Color $Data.po_status_color
    }
    $R++

    # --- ROW: BACKEND TASK ---
    $BE_Task = "  Task: " + $(if ($Data.backend_task) { $Data.backend_task } else { "(none)" })
    Print-Row $R $BE_Task "  Status: $($Data.po_next_decision)" $Half "Gray" $Data.po_status_color
    $R++
    
    # === SEPARATOR ===
    Print-Row $R "" "" $Half "DarkGray" "DarkGray"
    $R++

    # --- ROW: FRONTEND ---
    $FE_Color = if ($Data.frontend_status -eq "UP") { "Green" } elseif ($Data.frontend_status -eq "IDLE") { "Yellow" } else { "Red" }
    $FE_Txt = "FRONTEND [$($Data.frontend_status)]"
    Print-Row $R $FE_Txt "RECENT DECISIONS" $Half $FE_Color "Yellow"
    $R++
    
    # --- ROW: FRONTEND TASK & DECISION 1 ---
    $FE_Task = "  Task: " + $(if ($Data.frontend_task) { $Data.frontend_task } else { "(none)" })
    $D1 = if ($Decisions.Count -ge 1) { "  " + ($Decisions[-1] -replace "\|", "").Trim() } else { "  (none)" }
    Print-Row $R $FE_Task $D1 $Half "Gray" "Gray"
    $R++
    
    # --- ROW: DECISION 2 ---
    $D2 = if ($Decisions.Count -ge 2) { "  " + ($Decisions[-2] -replace "\|", "").Trim() } else { "" }
    Print-Row $R "" $D2 $Half "Gray" "Gray"
    $R++
    
    # === SEPARATOR ===
    Print-Row $R "" "" $Half "DarkGray" "DarkGray"
    $R++

    # --- ROW: QA ---
    $QA_Txt = "QA/AUDIT  Pending: " + $(if ($Data.qa_sessions) { $Data.qa_sessions } else { "0" })
    
    # HINT LOGIC: QA
    if ($Data.qa_sessions -and $Data.qa_sessions -gt 0) {
        Print-Row-With-Hint-Left $R $QA_Txt "WORKER COT" $Half "White" "Yellow" "-> /audit"
    }
    else {
        Print-Row $R $QA_Txt "WORKER COT" $Half "White" "Yellow"
    }
    $R++

    # --- ROW: LIBRARIAN & COT CONTENT ---
    $Lib_Txt = "LIBRARIAN [$($Data.lib_status_text)]"
    $COT = "  > " + $(if ($Data.worker_cot) { $Data.worker_cot } else { "Idling..." })
    
    # HINT LOGIC: LIBRARIAN
    $Hint = ""
    if ($Data.lib_status_text -match "MESSY") { $Hint = "-> /lib clean" }
    elseif ($Data.lib_status_text -match "CLUTTERED") { $Hint = "-> /lib scan" }
    elseif ($Data.lib_status_text -match "Inbox") { $Hint = "-> /ingest" }
    
    if ($Hint) {
        Print-Row-With-Hint-Left $R $Lib_Txt $COT $Half $Data.lib_status_color "Cyan" $Hint
    }
    else {
        Print-Row $R $Lib_Txt $COT $Half $Data.lib_status_color "Cyan"
    }
    $R++
    
    # === SEPARATOR ===
    Print-Row $R "" "" $Half "DarkGray" "DarkGray"
    $R++

    # --- ROW: LOG HEADER ---
    Print-Row $R "" "LIVE AUDIT LOG" $Half "DarkGray" "Yellow"
    $R++

    # --- ROW: LOGS ---
    $L1 = if ($AuditLog.Count -ge 1) { "  " + $AuditLog[-1] } else { "  (no logs)" }
    Print-Row $R "" $L1 $Half "Gray" "DarkGray"
    $R++

    # Fill remaining rows to reach input bar (v13.1: extend grid to bottom)
    $BottomRow = $Global:RowInput - 1
    while ($R -lt $BottomRow) {
        Print-Row $R "" "" $Half "DarkGray" "DarkGray"
        $R++
    }

    # Bottom Border (now at row just above input)
    Set-Pos $R 0; Write-Host ("+" + ("-" * ($Half - 2)) + "+") -NoNewline -ForegroundColor DarkGray
    Set-Pos $R $Half; Write-Host ("+" + ("-" * ($Half - 2)) + "+") -NoNewline -ForegroundColor DarkGray
}

# --- HELPER: Prints Row with a Hint on the Right Side ---
function Print-Row-With-Hint($Row, $LeftTxt, $RightTxt, $HalfWidth, $ColorL, $ColorR, $Hint) {
    $ContentWidth = $HalfWidth - 4
    
    # Draw Left
    Set-Pos $Row 0; Write-Host "| " -NoNewline -ForegroundColor DarkGray
    if ($LeftTxt.Length -gt $ContentWidth) { $LeftTxt = $LeftTxt.Substring(0, $ContentWidth - 3) + "..." }
    Write-Host $LeftTxt.PadRight($ContentWidth) -NoNewline -ForegroundColor $ColorL
    Write-Host " | | " -NoNewline -ForegroundColor DarkGray
    
    # Draw Right + Hint
    Set-Pos $Row $HalfWidth; Write-Host "| " -NoNewline -ForegroundColor DarkGray
    
    # Calc space for Right Text
    $Available = $ContentWidth - $Hint.Length - 1
    if ($RightTxt.Length -gt $Available) { $RightTxt = $RightTxt.Substring(0, $Available - 3) + "..." }
    
    Write-Host $RightTxt -NoNewline -ForegroundColor $ColorR
    Write-Host (" $Hint").PadRight($ContentWidth - $RightTxt.Length) -NoNewline -ForegroundColor Magenta
    
    Write-Host " |" -NoNewline -ForegroundColor DarkGray
}

# --- HELPER: Prints Row with a Hint on the Left Side ---
function Print-Row-With-Hint-Left($Row, $LeftTxt, $RightTxt, $HalfWidth, $ColorL, $ColorR, $Hint) {
    $ContentWidth = $HalfWidth - 4
    
    # Draw Left + Hint
    Set-Pos $Row 0; Write-Host "| " -NoNewline -ForegroundColor DarkGray
    
    $Available = $ContentWidth - $Hint.Length - 1
    if ($LeftTxt.Length -gt $Available) { $LeftTxt = $LeftTxt.Substring(0, $Available - 3) + "..." }
    
    Write-Host $LeftTxt -NoNewline -ForegroundColor $ColorL
    Write-Host (" $Hint").PadRight($ContentWidth - $LeftTxt.Length) -NoNewline -ForegroundColor Magenta
    
    Write-Host " | | " -NoNewline -ForegroundColor DarkGray
    
    # Draw Right
    Set-Pos $Row $HalfWidth; Write-Host "| " -NoNewline -ForegroundColor DarkGray
    if ($RightTxt.Length -gt $ContentWidth) { $RightTxt = $RightTxt.Substring(0, $ContentWidth - 3) + "..." }
    Write-Host $RightTxt.PadRight($ContentWidth) -NoNewline -ForegroundColor $ColorR
    Write-Host " |" -NoNewline -ForegroundColor DarkGray
}

# --- CLEAR DROPDOWN ZONE ---
function Clear-DropdownZone {
    $width = $Host.UI.RawUI.WindowSize.Width
    for ($i = 0; $i -lt $Global:MaxDropdownRows + 2; $i++) {
        Set-Pos ($Global:RowDropdown + $i) 0
        Write-Host (" " * $width) -NoNewline
    }
    # Restore cursor to input row (at left edge of input frame)
    Set-Pos $Global:RowInput $Global:InputLeft
}

# --- DRAW DROPDOWN AT FIXED POSITION ---
function Draw-Dropdown {
    param(
        [array]$Commands,
        [int]$SelectedIndex,
        [int]$ScrollOffset
    )
    
    if ($Commands.Count -eq 0) { return }
    
    $windowWidth = $Host.UI.RawUI.WindowSize.Width
    $midPoint = [Math]::Floor($windowWidth / 2)
    $colWidth = $midPoint - 1
    $cmdNameWidth = 12
    $descWidth = $colWidth - $cmdNameWidth - 2
    
    $numCols = 2
    $rowsNeeded = [Math]::Ceiling($Commands.Count / $numCols)
    $visible = [Math]::Min($rowsNeeded, $Global:MaxDropdownRows)
    
    for ($row = 0; $row -lt $visible; $row++) {
        $actualRow = $ScrollOffset + $row
        if ($actualRow -ge $rowsNeeded) { break }
        
        Set-Pos ($Global:RowDropdown + $row) 0
        
        for ($col = 0; $col -lt $numCols; $col++) {
            $idx = $actualRow + ($col * $rowsNeeded)
            
            if ($idx -lt $Commands.Count) {
                $cmd = $Commands[$idx]
                $isSelected = ($idx -eq $SelectedIndex)
                
                $cmdName = ("/" + $cmd.Name).PadRight($cmdNameWidth)
                $desc = $cmd.Desc
                if ($desc.Length -gt $descWidth) { $desc = $desc.Substring(0, $descWidth - 3) + "..." }
                $desc = $desc.PadRight($descWidth)
                
                if ($isSelected) {
                    Write-Host "> " -NoNewline -ForegroundColor Cyan
                    Write-Host $cmdName -NoNewline -ForegroundColor Yellow
                    Write-Host $desc -NoNewline -ForegroundColor White
                }
                else {
                    Write-Host "  " -NoNewline
                    Write-Host $cmdName -NoNewline -ForegroundColor DarkYellow
                    Write-Host $desc -NoNewline -ForegroundColor DarkGray
                }
            }
            else {
                Write-Host (" " * $colWidth) -NoNewline
            }
            
            if ($col -eq 0) {
                Write-Host "|" -NoNewline -ForegroundColor DarkGray
            }
        }
    }
    
    if ($rowsNeeded -gt $visible) {
        Set-Pos ($Global:RowDropdown + $visible) 0
        $below = $rowsNeeded - ($ScrollOffset + $visible)
        if ($below -gt 0) { Write-Host "  v$below more (arrows)" -ForegroundColor DarkGray }
    }
}

# --- v13.3: Compute recommended next action from state ---
function Get-RecommendedAction {
    # Priority-ordered checks
    try {
        # 1. Health failure
        if ($Global:HealthStatus -eq "FAIL") {
            return @{ Text = "/ops (health issue)"; Color = "Red" }
        }

        # 2. Check librarian status (messy)
        $stats = Get-WorkerStatus
        if ($stats.lib_status_text -match "MESSY|CLUTTERED") {
            return @{ Text = "/lib clean"; Color = "Yellow" }
        }

        # 3. Check for tasks
        $taskStats = Get-TaskStats
        if ($taskStats.pending -eq 0 -and $taskStats.in_progress -eq 0) {
            return @{ Text = "type a goal (e.g., 'add JWT auth')"; Color = "Cyan" }
        }

        # 4. Tasks pending - suggest run
        if ($taskStats.pending -gt 0) {
            return @{ Text = "Enter = execute"; Color = "Green" }
        }

        # 5. Default
        return @{ Text = "/ops"; Color = "Gray" }
    }
    catch {
        return @{ Text = "/ops"; Color = "Gray" }
    }
}

# --- v13.3.6: Framed Input Bar with Unicode borders ---
# ALIGNMENT: Input bar starts at $Global:InputLeft to align with "  Next:" label
# Box width = terminal width - InputLeft (right edge at terminal width - 1)
function Draw-InputBar {
    param([int]$width, [int]$rowInput)

    $left = $Global:InputLeft
    $topRow = $rowInput - 1
    $bottomRow = $rowInput + 1
    $boxWidth = $width - $left - 1  # width of box from InputLeft to right edge
    $innerWidth = $boxWidth - 2      # space between left and right borders

    # Top border: ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    Set-Pos $topRow $left
    Write-Host ("‚îå" + ("‚îÄ" * $innerWidth) + "‚îê") -NoNewline -ForegroundColor DarkGray

    # Middle line: ‚îÇ >         ‚îÇ
    Set-Pos $rowInput $left
    Write-Host "‚îÇ" -NoNewline -ForegroundColor DarkGray
    Write-Host " > " -NoNewline -ForegroundColor White
    Write-Host (" " * ($innerWidth - 3)) -NoNewline  # 3 = " > " length
    Write-Host "‚îÇ" -NoNewline -ForegroundColor DarkGray

    # Bottom border: ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    Set-Pos $bottomRow $left
    Write-Host ("‚îî" + ("‚îÄ" * $innerWidth) + "‚îò") -NoNewline -ForegroundColor DarkGray

    # Position cursor where typing starts: after "‚îÇ > " = InputLeft + 4
    Set-Pos $rowInput ($left + 4)
}

# Helper: Clear just the input content, preserving borders
function Clear-InputContent {
    param([int]$width, [int]$rowInput)
    $left = $Global:InputLeft
    $boxWidth = $width - $left - 1
    $innerWidth = $boxWidth - 2
    Set-Pos $rowInput $left
    Write-Host "‚îÇ" -NoNewline -ForegroundColor DarkGray
    Write-Host " > " -NoNewline -ForegroundColor White
    Write-Host (" " * ($innerWidth - 3)) -NoNewline
    Write-Host "‚îÇ" -NoNewline -ForegroundColor DarkGray
    Set-Pos $rowInput ($left + 4)
}

# --- v13.3.5: Editor-Style Footer Bar (Next: left, [MODE] right) ---
# Clean coding-CLI style: "Next: <hint>" on left, [MODE] on right
function Draw-FooterBar {
    $footerRow = $Global:RowInput - 2
    $microHintRow = $Global:RowInput - 3
    $width = $Host.UI.RawUI.WindowSize.Width

    # Clear lines
    Set-Pos $microHintRow 0
    Write-Host (" " * ($width - 1)) -NoNewline
    Set-Pos $footerRow 0
    Write-Host (" " * ($width - 1)) -NoNewline

    # SANDBOX UX: Mode micro-hint
    $config = $Global:ModeConfig[$Global:CurrentMode]
    if ($config.MicroHint) {
        Set-Pos $microHintRow 2
        Write-Host $config.MicroHint -ForegroundColor DarkGray -NoNewline
    }

    # SANDBOX UX: First-time hint
    $stats = Get-TaskStats
    $hasTasks = ($stats.pending -gt 0 -or $stats.in_progress -gt 0 -or $stats.completed -gt 0)
    if (-not $hasTasks) {
        Set-Pos $footerRow 2
        Write-Host "First time here? Type /init to bootstrap a new project." -ForegroundColor DarkGray -NoNewline
    }
    else {
        $scenario = Get-SystemScenario
        $nextHint = switch ($scenario) {
            "fresh" { "/init" }
            "messy" { "/lib clean" }
            "pending" { "/run" }
            default { "/ops" }
        }
        Set-Pos $footerRow 0
        Write-Host "  Next: " -NoNewline -ForegroundColor DarkGray
        Write-Host $nextHint -NoNewline -ForegroundColor Cyan
    }

    # Mode badge (right-aligned)
    $modeColors = @{
        "OPS"  = "Cyan"
        "PLAN" = "Yellow"
        "RUN"  = "Magenta"
        "SHIP" = "Green"
    }
    $modeLabel = "[$($Global:CurrentMode)]"
    $modeColor = $modeColors[$Global:CurrentMode]
    $col = $width - $modeLabel.Length - 1
    if ($col -lt 0) { $col = 0 }
    Set-Pos $footerRow $col
    Write-Host $modeLabel -NoNewline -ForegroundColor $modeColor

    # SANDBOX UX: Router debug overlay
    if ($Global:RouterDebug -and $Global:LastRoutedCommand) {
        $debugRow = $Global:RowInput - 4
        Set-Pos $debugRow 0
        Write-Host (" " * ($width - 1)) -NoNewline
        Set-Pos $debugRow 2
        Write-Host "‚Üí Routed to: $($Global:LastRoutedCommand)" -ForegroundColor Magenta -NoNewline
    }
}

# Legacy aliases for compatibility
function Draw-ModeStrip { Draw-FooterBar }
function Draw-ModeToggleStrip { Draw-FooterBar }
function Draw-SmartHintStrip { Draw-FooterBar }

# --- STABLE INPUT WITH FULL READKEY LOOP (backspace works on all chars) ---
# v13.3.6: Editor-style footer above framed input (Next: left, [MODE] right)
# Layout: Footer(RowInput-2), TopBorder(RowInput-1), Input(RowInput), BottomBorder(RowInput+1)
# ALIGNMENT: Input bar starts at $Global:InputLeft, cursor at InputLeft + 4
function Read-StableInput {
    $width = $Host.UI.RawUI.WindowSize.Width
    $left = $Global:InputLeft
    $boxWidth = $width - $left - 1
    $innerWidth = $boxWidth - 2
    $maxInputLen = $innerWidth - 3    # max text length (innerWidth minus " > ")
    $cursorStart = $left + 4          # after "‚îÇ > "

    # v13.3.5: Draw footer first (above input)
    Draw-FooterBar

    # Draw the framed input bar
    Draw-InputBar -width $width -rowInput $Global:RowInput

    # Return cursor to input line (inside frame, after "‚îÇ > ")
    Set-Pos $Global:RowInput $cursorStart

    $buffer = ""
    $cursorCol = $cursorStart

    while ($true) {
        $key = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")

        # Enter - submit
        if ($key.VirtualKeyCode -eq 13) {
            return $buffer
        }

        # Escape - cancel
        if ($key.VirtualKeyCode -eq 27) {
            return ""
        }

        # Tab or Shift+Tab - toggle OPS ‚Üî PLAN
        if ($key.VirtualKeyCode -eq 9) {
            # Simple toggle between OPS and PLAN
            $Global:CurrentMode = if ($Global:CurrentMode -eq "OPS") { "PLAN" } else { "OPS" }

            # Redraw footer bar to update mode indicator
            Draw-FooterBar

            # Return cursor to input position
            Set-Pos $Global:RowInput $cursorCol
            continue
        }

        # Backspace - delete last character
        if ($key.VirtualKeyCode -eq 8) {
            if ($buffer.Length -gt 0) {
                $buffer = $buffer.Substring(0, $buffer.Length - 1)
                $cursorCol--
                # Erase character on screen
                Set-Pos $Global:RowInput $cursorCol
                Write-Host " " -NoNewline
                Set-Pos $Global:RowInput $cursorCol
            }
            continue
        }

        # Get character
        $char = $key.Character

        # Slash as FIRST character - show command picker
        if ($buffer.Length -eq 0 -and $char -eq '/') {
            Write-Host "/" -NoNewline -ForegroundColor Yellow
            $pickerResult = Show-CommandPicker
            if ($pickerResult.Kind -eq "select") {
                return $pickerResult.Command
            }
            # Cancelled - clear input content preserving borders
            Clear-InputContent -width $width -rowInput $Global:RowInput
            $buffer = ""
            $cursorCol = $cursorStart
            continue
        }

        # Printable character - add to buffer (respect right border)
        # Max cursor position = width - 2 (one before the right border)
        if ($char -and [int]$char -ge 32 -and $buffer.Length -lt $maxInputLen) {
            $buffer += $char
            Write-Host $char -NoNewline
            $cursorCol++
        }
    }
}

# --- COMMAND PICKER (Arrow key navigation + type-ahead filter) ---
# v13.3.5: Dropdown starts below bottom border (RowInput+2)
function Show-CommandPicker {
    # Get Golden Path commands (default view)
    $goldenCmds = Get-PickerCommands -Filter ""

    if ($goldenCmds.Count -eq 0) { return @{ Kind = "cancel" } }

    # v13.3.5: Get fresh layout values
    $layout = Get-PromptLayout
    $rowInput = $layout.RowInput
    $dropdownRow = $layout.DropdownRow  # Now at RowInput + 2 (below bottom border)
    $width = $layout.Width
    $maxVisible = $layout.MaxVisible

    $script:pickerFilter = ""
    $script:pickerSelectedIdx = 0
    $script:pickerScrollOffset = 0

    # Helper: Clear only the dropdown area (not the framed input or footer)
    function ClearDropdownOnly {
        # Clear dropdown rows only (RowInput+2 and below)
        for ($i = 0; $i -le $maxVisible; $i++) {
            Set-Pos ($dropdownRow + $i) 0
            Write-Host (" " * $width) -NoNewline
        }
    }

    # Draw dropdown (below the bottom border)
    function DrawPickerDropdown {
        $cmdList = Get-PickerCommands -Filter $script:pickerFilter

        # Update input line content (inside the frame): ‚îÇ > /filter ‚îÇ
        # Clear and redraw the middle of the frame
        $left = $Global:InputLeft
        $boxWidth = $width - $left - 1
        $innerWidth = $boxWidth - 2
        Set-Pos $rowInput $left
        Write-Host "‚îÇ" -NoNewline -ForegroundColor DarkGray
        Write-Host " > " -NoNewline -ForegroundColor White
        Write-Host "/" -NoNewline -ForegroundColor Yellow
        Write-Host $script:pickerFilter -NoNewline -ForegroundColor Cyan
        $usedChars = 4 + $script:pickerFilter.Length  # " > /" + filter
        $remaining = $innerWidth - $usedChars
        if ($remaining -gt 0) {
            Write-Host (" " * $remaining) -NoNewline
        }
        Write-Host "‚îÇ" -NoNewline -ForegroundColor DarkGray

        # Draw dropdown items
        for ($i = 0; $i -lt $maxVisible; $i++) {
            Set-Pos ($dropdownRow + $i) 0
            $cmdIdx = $script:pickerScrollOffset + $i
            if ($cmdIdx -lt $cmdList.Count) {
                $cmd = $cmdList[$cmdIdx]
                $isSelected = ($cmdIdx -eq $script:pickerSelectedIdx)
                $prefix = if ($isSelected) { "> " } else { "  " }
                $cmdName = "/" + $cmd.Name
                $cmdText = "$prefix$cmdName - $($cmd.Desc)"
                if ($cmdText.Length -gt $width - 2) { $cmdText = $cmdText.Substring(0, $width - 5) + "..." }
                $cmdText = $cmdText.PadRight($width)

                if ($isSelected) {
                    Write-Host $cmdText -NoNewline -ForegroundColor Yellow -BackgroundColor DarkGray
                }
                else {
                    Write-Host $cmdText -NoNewline -ForegroundColor Gray
                }
            }
            else {
                Write-Host (" " * $width) -NoNewline
            }
        }
        # Footer hint for dropdown
        Set-Pos ($dropdownRow + $maxVisible) 0
        if ($script:pickerFilter -eq "") {
            Write-Host ("  /help --all for full registry").PadRight($width) -ForegroundColor DarkGray -NoNewline
        }
        else {
            $below = $cmdList.Count - $script:pickerScrollOffset - $maxVisible
            if ($below -gt 0) {
                Write-Host ("  ‚Üì$below more").PadRight($width) -ForegroundColor DarkGray -NoNewline
            }
            else {
                Write-Host (" " * $width) -NoNewline
            }
        }
        # Cursor back to input line (inside frame, after "‚îÇ > /filter")
        Set-Pos $rowInput ($Global:InputLeft + 5 + $script:pickerFilter.Length)

        return $cmdList
    }

    $filteredCmds = DrawPickerDropdown

    while ($true) {
        $keyPress = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        $filteredCmds = Get-PickerCommands -Filter $script:pickerFilter

        # Enter - select command
        if ($keyPress.VirtualKeyCode -eq 13) {
            if ($filteredCmds.Count -gt 0) {
                ClearDropdownOnly
                return @{ Kind = "select"; Command = "/" + $filteredCmds[$script:pickerSelectedIdx].Name }
            }
            continue
        }

        # Escape - cancel
        if ($keyPress.VirtualKeyCode -eq 27) {
            ClearDropdownOnly
            return @{ Kind = "cancel" }
        }

        # Backspace - remove filter char OR exit picker if empty
        if ($keyPress.VirtualKeyCode -eq 8) {
            if ($script:pickerFilter.Length -gt 0) {
                $script:pickerFilter = $script:pickerFilter.Substring(0, $script:pickerFilter.Length - 1)
                $script:pickerSelectedIdx = 0
                $script:pickerScrollOffset = 0
                DrawPickerDropdown | Out-Null
            }
            else {
                # v13.3.2: Backspace on empty = exit picker (delete the /)
                ClearDropdownOnly
                return @{ Kind = "cancel" }
            }
            continue
        }

        # Down arrow
        if ($keyPress.VirtualKeyCode -eq 40) {
            if ($script:pickerSelectedIdx -lt $filteredCmds.Count - 1) {
                $script:pickerSelectedIdx++
                if ($script:pickerSelectedIdx -ge $script:pickerScrollOffset + $maxVisible) { $script:pickerScrollOffset++ }
                DrawPickerDropdown | Out-Null
            }
            continue
        }

        # Up arrow
        if ($keyPress.VirtualKeyCode -eq 38) {
            if ($script:pickerSelectedIdx -gt 0) {
                $script:pickerSelectedIdx--
                if ($script:pickerSelectedIdx -lt $script:pickerScrollOffset) { $script:pickerScrollOffset-- }
                DrawPickerDropdown | Out-Null
            }
            continue
        }
        
        # Letter keys - add to filter
        $charPressed = $keyPress.Character
        if ($charPressed -and $charPressed -match '^[a-zA-Z0-9]$') {
            $script:pickerFilter += $charPressed.ToString().ToLower()
            $script:pickerSelectedIdx = 0
            $script:pickerScrollOffset = 0
            DrawPickerDropdown | Out-Null
            continue
        }
    }
}

# ============================================================================
# v13.3.1: SCENARIO HINT (action-based, not tech explanation)
# ============================================================================

function Get-SystemScenario {
    # Detect current system state for scenario-based hints
    try {
        $stats = Get-TaskStats
        $hasTasks = ($stats.pending -gt 0 -or $stats.in_progress -gt 0 -or $stats.completed -gt 0)

        # Check for sources/domain rules
        $hasSources = (Test-Path (Join-Path $CurrentDir "docs\DOMAIN_RULES.md")) -or
        (Test-Path (Join-Path $CurrentDir "control\sources"))

        # Check librarian status
        $workerStatus = Get-WorkerStatus
        $isMessy = $workerStatus.lib_status_text -match "MESSY|CLUTTERED"

        if (-not $hasSources -and -not $hasTasks) {
            return "fresh"      # Brand new project
        }
        elseif ($isMessy) {
            return "messy"      # Needs cleanup
        }
        elseif ($stats.pending -gt 0) {
            return "pending"    # Has work to do
        }
        else {
            return "normal"     # Standard state
        }
    }
    catch {
        return "normal"
    }
}

# v13.3.3: Legacy alias - now delegates to Draw-FooterBar
function Show-ScenarioHint {
    Draw-FooterBar
}

# ============================================================================
# MAIN LOOP
# ============================================================================

function Initialize-Screen {
    # Ensure minimum window size
    $W = $Host.UI.RawUI.WindowSize.Width
    $H = $Host.UI.RawUI.WindowSize.Height
    if ($H -lt 25) {
        try { $Host.UI.RawUI.WindowSize = New-Object System.Management.Automation.Host.Size($W, 30) } catch {}
    }

    # v13.1: Update health status (shown in header)
    $Global:HealthStatus = Get-SystemHealthStatus

    Clear-Host

    # Draw header at row 0
    Set-Pos $Global:RowHeader 0
    Show-Header

    # Draw dashboard starting at row 4 (original layout unchanged)
    Draw-Dashboard
}

# Initial setup
Initialize-Screen

# Main loop
while ($true) {
    $userInput = Read-StableInput

    # Output appears at row 16 (just before input)
    Set-Pos ($Global:RowInput - 1) 0
    $width = $Host.UI.RawUI.WindowSize.Width
    Write-Host (" " * $width) -NoNewline
    Set-Pos ($Global:RowInput - 1) 0

    # v13.2: Empty Enter ‚Üí run default action for current mode
    if ([string]::IsNullOrWhiteSpace($userInput)) {
        Invoke-DefaultAction
        continue
    }

    # v13.2: Mode switch aliases (:ops, :plan, :run, :ship)
    if ($userInput -match "^:(ops|plan|run|ship)$") {
        Switch-Mode -NewMode $Matches[1]
        continue
    }

    # Slash commands (explicit)
    if ($userInput.StartsWith("/")) {
        $parts = $userInput.TrimStart("/").Split(" ", 2)
        $cmdName = $parts[0].ToLower()

        if ($Global:Commands.Contains($cmdName)) {
            $result = Invoke-SlashCommand -UserInput $userInput
            if ($result -eq "refresh") { Initialize-Screen }
        }
        else {
            Write-Host "  Unknown command: /$cmdName" -ForegroundColor Yellow
        }
    }
    else {
        # v13.2: Plain text ‚Üí modal routing (no backend calls)
        Invoke-ModalRoute -Text $userInput
    }
}

# v22.0 Changelog - Model Tier Routing & Machine Registry

## Summary
This release introduces intelligent model routing based on task lane/archetype and establishes a machine-readable project navigation system.

---

## 1. Model Tier Routing

### New Model Matrix
| Lane | Claude Worker | Codex Worker | Model Used |
|------|---------------|--------------|------------|
| backend | - | gpt-5.1-codex-max | logic_max |
| frontend | claude-sonnet-4-5 | - | creative_fast |
| qa | claude-sonnet-4-5 | gpt-5.1-codex-max | **DUAL** |
| docs | claude-opus-4-5 | - | reasoning_ultra |
| ops | - | gpt-5.1-codex-max | logic_max |

### Files Changed
- **mesh_server.py**
  - Added `MODEL_TIER_BY_LANE` dict (line 103)
  - Added `MODEL_TIER_BY_ARCHETYPE` dict (line 112)
  - Added `_resolve_model_tier()` function (line 123)
  - Updated `pick_task_braided()` to return `model_tier` in response
  - Added `model_tier` column migration to tasks table

- **worker.ps1**
  - Added `-DefaultModel` parameter
  - Extract `model_tier` from scheduler response
  - Map tier to Claude model IDs in execution block
  - Updated codex to use `-m gpt-5.1-codex-max`

### QA Duo Play Strategy
```
v22.0: "First to Claim" - both workers compete, winner executes (load balancing)
v23.0: "Task Forking" - QA task spawns two sub-tasks, one per worker (planned)
```

---

## 2. Lane Routing Updates

### Worker Allowed Lanes
| Worker Type | Allowed Lanes |
|-------------|---------------|
| backend (codex) | backend, qa, ops |
| frontend (claude) | frontend, docs, qa |
| qa | qa |
| ops | ops |
| docs | docs |

### Files Changed
- **mesh_server.py**: Updated `DEFAULT_WORKER_ALLOWED_LANES` to add `qa` to frontend worker
- **worker.ps1**: Updated `Get-BlockedLanes` to match server-side policy

---

## 3. Machine Registry (One-to-One Address Book)

### New File: `project_map.yaml`
Central manifest for AI and developer navigation.

**Features:**
- `schema_version: "1.0"` for compatibility
- Typed exports with line numbers
- Machine-queryable intent index
- Structured data flow edges
- Model routing reference

### Components Registered
| machine_id | File | Responsibility |
|------------|------|----------------|
| sys:scheduler | mesh_server.py | Task selection, priority logic |
| sys:worker | worker.ps1 | Process management, task claiming |
| sys:ai_client | mcp_client.py | MCP protocol bridge |
| sys:cli | Invoke-CommandRouter.ps1 | User CLI, command parsing |

### Standard Headers Added
All 4 core files now have machine-identifiable headers:
```
# ---------------------------------------------------------
# COMPONENT: <NAME> (<machine_id>)
# FILE: <filename>
# MAPPING: <responsibility>
# EXPORTS: <key functions>
# CONSUMES: <dependencies>
# VERSION: v22.0
# ---------------------------------------------------------
```

---

## 4. Intent Map (Quick Reference)

| Intent | Target |
|--------|--------|
| Change task priority | `mesh_server.py` → `pick_task_braided` |
| Change worker behavior | `worker.ps1` → Main Loop |
| Change AI model/prompts | `worker.ps1` → `$ModelId` switch |
| Change UI commands | `Invoke-CommandRouter.ps1` |
| Add new MCP tool | `mesh_server.py` → `@mcp.tool()` |
| Debug empty logs | `worker.ps1` → `$LogFile` |
| Change lane routing | `mesh_server.py` → `DEFAULT_WORKER_ALLOWED_LANES` |
| Change model tier | `mesh_server.py` → `MODEL_TIER_BY_LANE` |

---

## 5. Files Modified (This Session)

### Core Changes
- `mesh_server.py` - Model tier routing + machine header
- `worker.ps1` - Model execution + machine header
- `mcp_client.py` - Machine header
- `src/AtomicMesh.UI/Public/Invoke-CommandRouter.ps1` - Machine header

### New Files
- `project_map.yaml` - Machine registry manifest
- `docs/v22.0_CHANGELOG.md` - This document

---

## 6. Validation

```bash
# Verify YAML syntax
python -c "import yaml; yaml.safe_load(open('project_map.yaml'))"

# Verify Python syntax
python -m py_compile mesh_server.py
python -m py_compile mcp_client.py
```

---

## Migration Notes

- No breaking changes to existing task data
- `model_tier` column auto-migrates with default `'sonnet'`
- Existing workers continue to function (model tier is optional)
- Headers are comments only - no functional impact
